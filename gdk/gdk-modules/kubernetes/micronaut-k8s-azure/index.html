<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="/gdk/resources/img/graalvm.png" />
  <meta name="twitter:widgets:border-color" content="#55acee">

  <title>
    
      Deploy a Micronaut Microservices Application to the Azure Kubernetes Service
    
  </title>
  <meta name="description" content="The Graal Development Kit for Micronaut (GDK) is a build of a curated set of Micronaut framework modules and their required libraries for building portable c..."/>
  <meta name="last_modified" content="2024-10-14 13:10:56 +0000"/>
  <meta name="last_built" content="2024-12-03 15:52:34 +0000"/>
  <link rel="stylesheet" href="/gdk/assets/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/gdk/resources/img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/gdk/resources/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/gdk/resources/img/favicon/favicon-16x16.png">
  <link rel="manifest" href="/gdk/resources/img/favicon/site.webmanifest">
  <link rel="stylesheet" type="text/css" href="/gdk/resources/styles/codicon.css" />
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="-vRqwa9WYn6AaQGnl88xvrLw6ac4xoKVkZkhanmlRhU" />
  <link rel="canonical" href="https://www.graal.cloud/gdk/gdk-modules/kubernetes/micronaut-k8s-azure/">

  <!-- jQuery UI Tabs -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/gdk/resources/lib/jquery/jquery-ui.css">
</head>

      <script src="/gdk/resources/lib/jquery/jquery-3.7.1.min.js"></script>
    <script src="/gdk/resources/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src='/gdk/resources/lib/sticky-sidebar/resizeSensor.js'></script>
    <script src='/gdk/resources/lib/sticky-sidebar/sticky-sidebar.min.js'></script>
    <script src="/gdk/resources/lib/highlight/highlight.min.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Add TRUSTe Consent Script and Analytics -->
    <script async="async" type="text/javascript" src='//consent.trustarc.com/notice?domain=oracle.com&c=teconsent&js=bb&noticeType=bb&text=true&cdn=1&pcookie&gtm=1' crossorigin></script>
    <script src="https://www.oracle.com/assets/truste-oraclelib.js"></script>
    <!-- jQuery UI Tabs -->
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>


  <body class="preload">
    <!-- Start SiteCatalyst code -->
    <script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script>
    <!-- End SiteCatalyst code -->

    <div  class="wrapper wrapper--nofooter" >

      <header  class="header header--content" 
  role="banner">

  

  

    <nav class="menu">
      <div class="menu__row">
        <div>
          <a href="/gdk/">
            <img class="logo-mobile" src="/gdk/resources/img/gdk-logo-new.svg" alt="Graal Development Kit for Micronaut logo">
          </a>
        </div>
        <div class="menu__container">
          <ul class="menu__list">
            <li class="menu__item">
              <a href="/gdk/about/" class="menu__link">About</a>
            </li>
            <li class="menu__item">
              <a href="/gdk/get-started/" class="menu__link">Get Started</a>
            </li>
            <li class="menu__item">
              <div class="stack-container">
                <a href="#" class="menu__link stack__header">Docs</a>
                <div class="stack-menu-learn">
                  <div class="stack-row">
                    <div class="stack-column">
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/modules.svg'>
                        <a href="/gdk/modules/" class="item-line">Modules</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/guides.svg'>
                        <a href="/gdk/guides/" class="item-line">Guides</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/labs.svg'>
                        <a href="/gdk/hands-on-labs/" class="item-line">Hands-On Labs</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/tools.svg'>
                        <a href="/gdk/vscode-tools/" class="item-line">Tools</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <li class="menu__item">
              <div class="stack-container">
                <a href="#" class="menu__link stack__header">Graal Projects</a>
                <div class="stack-menu">
                  <div class="stack-row">
                    <div class="stack-column">
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalstack.svg'>
                        <a href="https://graal.cloud/" class="item-line">Graal</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalvm.svg'>
                        <a href="https://graalvm.org/" class="item-line">GraalVM</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalos.svg'>
                        <a href="https://graal.cloud/graalos/" class="item-line">GraalOS</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <li class="menu__launch__mobile">
              <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
            </li>
          </ul>
        </div>
        <div class="menu__launch">
          <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
        </div>
      </div>

      <div role="button" class="menu-btn menu-btn--menu js-show-menu" tabindex="-1" title="sweet hamburger">
        <div class="hamburger">
          <div class="inner"></div>
        </div>
      </div>
      <button aria-label="hamburger mobile menu" class="btn btn-mobile-menu js-show-menu">
        <div class="inner"></div>
      </button>
    </nav>

  
</header>


      <main  class="content"   aria-label="Content">
        <div class="wrapper wrapper-content">
  <article>
  <div class="row d-flex flex-wrap">
    <div class="col-sm-3 docsimpro col-bg">
      <div class="sidebar-wrap">
        <div class="sidebar">
          <div class="menuabout">
            <img id="sidebarClose" src="/gdk/resources/img/arrow_sidebar(close).svg" alt="Expand or collapse sidebar"
              class="btn-color no-display">
            <img id="sidebarOpen" src="/gdk/resources/img/arrow_sidebar.svg" alt="Expand or collapse sidebar">
          </div>
          
<div class="toc-floating">


<div class="toc-bullets">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    

    
      
        
          <li class="toc-bullets-main">
        
          
          <a href="/gdk/docs/gdk-modules/kubernetes/" class="_icon-book">
            Kubernetes
          </a>
        </li>

        
        

        
        
          
          <li class="toc-bullets-sub toc-bullets-highlight">
          
            
            <a href="/gdk/gdk-modules/kubernetes/micronaut-k8s-azure/">
              Deploy a Micronaut Microservices Application to the Azure Kubernetes Service
            </a>
          </li>

          
            <div>
  <script>
    var scriptElement = document.currentScript;
    var div = $(scriptElement.parentElement);
    $(window).on("load", function () {
      $("#content-wrapper h2").each(function () {
        var li = $("<li></li>", { class: "toc-bullets-sub toc-bullets-sub-3" });
        var a = $("<a></a>", { href: "#" + $(this).attr("id") });
        a.text($(this).text().replace('#', ''));
        li.append(a);
        li.click(function (e) {
          e.preventDefault();
          var target = $(a.attr('href'));
          var scrollTo = target.offset().top - 80; // 80 - indent
          $('html, body').animate({ scrollTop: scrollTo }, 1000);
        });
        div.append(li);
      });
    });
  </script>
</div>
          
        
      
    
  

<!-- <li class="search additional-search">
  <form class="form-inline sidebar" action="/docs/search" autocomplete="on" method="get">
    <input class="input-search sidebar" type="text" id="search-box" name="query" placeholder="Search">
    <button type="submit sidebar" class="search-button"></button>
  </form>
</li> -->

</div>
  <!-- Search form -->
  <!-- <form class="search-container" action="/docs/search" autocomplete="on" method="get">
   <label for="search-box">Search</label>
    <input type="text" id="search-box" name="query">
    <button type="submit" class="searchbttn"></button>
  </form> -->
</div>

        </div>
      </div>
    </div>

    <div class="col-sm-9 docsmod">
      <div id="content-wrapper" class="docs-content docs-content--with-sidebar">
        <!--
          Include file to warn of Windows/Gradle restriction
        -->
        <h1 id="deploy-a-micronaut-microservices-application-to-the-azure-kubernetes-service">
        
        
          Deploy a Micronaut Microservices Application to the Azure Kubernetes Service
        
        
      </h1>

<p>This guide shows how to deploy a Micronaut<sup>®</sup> application, consisting of three microservices, to the <a href="https://learn.microsoft.com/en-us/azure/aks/what-is-aks">Azure Kubernetes Service (AKS)</a> using the <a href="https://micronaut-projects.github.io/micronaut-kubernetes/latest/guide/">Micronaut Kubernetes project</a>.</p>
<blockquote>
  <p>The Micronaut Kubernetes project provides integration between Micronaut and Kubernetes.
It adds support for the following features:</p>
  <ul>
    <li>Service Discovery</li>
    <li>Configuration client for config maps and secrets</li>
    <li>Kubernetes blocking and non-blocking clients built on top of the official Kubernetes Java SDK</li>
  </ul>
</blockquote>

<p>AKS is a managed Kubernetes service for deploying containerized applications to the cloud.
The guide demonstrates how to use Kubernetes Service Discovery and Distributed Configuration to connect three microservices, and discover how Micronaut integration with Kubernetes simplifies deployment to AKS.
The application consists of three microservices:</p>

<ul>
  <li><em>users</em> - contains customer data that can place orders on items, also a new customer can be created. It requires HTTP basic authentication to access it.</li>
  <li><em>orders</em> - contains all orders that customers have created as well as available items that customers can order. This microservice also enables the creation of new orders. It requires HTTP basic authentication to access it.</li>
  <li><em>api</em> - acts as a gateway to the <em>orders</em> and <em>users</em> microservices. It combines results from both microservices and checks data when a customer creates a new order.</li>
</ul>
    
      <h3 id="prerequisites">
        
        
          Prerequisites <a href="#prerequisites" class="anchor_heading">#</a>
        
        
      </h3>

<ul>
  <li>JDK 17 or higher. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>.</li>
  <li>An Azure account. See <a href="/gdk/get-started/setting-up-cloud-accounts/">Setting up Your Cloud Accounts</a>.</li>
  <li>The Azure CLI. Follow the <a href="https://learn.microsoft.com/cli/azure/install-azure-cli">Azure documentation</a> for installing or updating the latest version of the Azure CLI.</li>
  <li>An Azure user with sufficient permissions to create and manage AKS and <a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-intro">Azure Container Registry (ACR)</a>.</li>
  <li>A Docker-API compatible container runtime such as <a href="https://docs.rancherdesktop.io/getting-started/installation/">Rancher Desktop</a> or <a href="https://www.docker.io/gettingstarted/">Docker</a> installed and running.</li>
  <li><a href="https://kubernetes.io/docs/reference/kubectl/"><code>kubectl</code></a> to deploy the application to AKS.</li>
</ul>
    
      <h4 id="a-note-regarding-your-development-environment">
        
        
          A note regarding your development environment
        
        
      </h4>

<p>Consider using Visual Studio Code, which provides native support for developing applications with the <a href="/gdk/vscode-tools/using-gdk-vscode-tools/">Graal Development Kit extension</a>.</p>

<blockquote>
  <p>Note: If you use IntelliJ IDEA, <a href="/gdk/resources/img/annotationprocessorsintellij.png">enable annotation processing</a>.</p>
</blockquote>

<blockquote>
  <p>Windows platform: The GDK guides are compatible with Gradle only. Maven support is coming soon.</p>
</blockquote>
    
      <h2 id="1-create-or-download-a-microservices-application">
        
        
          1. Create or Download a Microservices Application <a href="#1-create-or-download-a-microservices-application" class="anchor_heading">#</a>
        
        
      </h2>

<p>You can create a microservices application from scratch by following <a href="/gdk/gdk-modules/kubernetes/micronaut-k8s/">this guide</a>, or you can download the completed example:</p>

<div id="tabs-doc1">
  <ul>
    <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <p><a href="https://github.com/oracle/graal-dev-kit/releases/download/4.6.0.6/4.6.0.6_kubernetes_azure-kubernetes-demo-java-gradle.zip">Gradle Azure Kubernetes Example <img class="download-img-guides" src="/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" /></a>
    </p>
  </div>
  <div id="maven">
    <p><a href="https://github.com/oracle/graal-dev-kit/releases/download/4.6.0.6/4.6.0.6_kubernetes_azure-kubernetes-demo-java-maven.zip">Maven Azure Kubernetes Example <img class="download-img-guides" src="/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" /></a>
    </p>
  </div>
</div>

<p>The application ZIP file will be downloaded to your default downloads directory. Unzip it, open it in your code editor, and proceed to the next steps.</p>

<blockquote>
  <p>Note: By default, a Micronaut application detects its runtime environment.
A detected environment (in this case, <strong>k8s</strong>) overrides the default specified environment (in this case, <strong>azure</strong>).
This means that you should locate your configuration in the <em>application-k8s.properties</em> and <em>bootstrap-k8s.properties</em> files.
Alternatively, you can specify the <code>azure</code> environment passing it as a command-line option (<code>-Dmicronaut.environments=azure</code>) or via an environment variable (<code>MICRONAUT_ENVIRONMENTS=azure</code>).</p>
</blockquote>
    
      <h2 id="2-prepare-to-deploy-microservices">
        
        
          2. Prepare to Deploy Microservices <a href="#2-prepare-to-deploy-microservices" class="anchor_heading">#</a>
        
        
      </h2>
    
      <h3 id="21-create-a-resource-group">
        
        
          2.1. Create a Resource Group <a href="#21-create-a-resource-group" class="anchor_heading">#</a>
        
        
      </h3>

<p>We recommend that you create a new <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/overview#resource-groups">resource group</a> for this guide, but you can use an existing resource group instead.</p>

<p>Run the <a href="https://learn.microsoft.com/en-us/cli/azure/group?view=azure-cli-latest#az-group-create">az group create</a> command to create a resource group named <em>gdkguides</em> in the <em>eastus</em> region:</p>

<pre><code class="language-bash">az group create --location eastus --name gdkguides
</code></pre>

<p>If you prefer using the region geographically closer to you, run <code>az account list-locations</code> to list all available regions.</p>
    
      <h3 id="22-register-microsoftcontainerregistry-as-a-resource-provider">
        
        
          2.2. Register Microsoft.ContainerRegistry as a Resource Provider <a href="#22-register-microsoftcontainerregistry-as-a-resource-provider" class="anchor_heading">#</a>
        
        
      </h3>

<p>Run the <a href="https://learn.microsoft.com/cli/azure/provider?view=azure-cli-latest#az-provider-register"><code>az provider register</code></a> command to register <em>Microsoft.ContainerRegistry</em> as a Resource Provider:</p>

<pre><code class="language-bash">az provider register --namespace 'Microsoft.ContainerRegistry'
</code></pre>

<p>This will take a while to execute. Check the status:</p>

<pre><code class="language-bash">az provider show --namespace Microsoft.ContainerRegistry
</code></pre>

<p>Once the <code>"registrationState": "Registering"</code>  changes to <code>"registrationState": "Registered"</code>, the registration is complete.</p>
    
      <h3 id="23-register-microsoftcontainerservice-as-a-resource-provider">
        
        
          2.3. Register Microsoft.ContainerService as a Resource Provider <a href="#23-register-microsoftcontainerservice-as-a-resource-provider" class="anchor_heading">#</a>
        
        
      </h3>

<p>Run the <a href="https://learn.microsoft.com/cli/azure/provider?view=azure-cli-latest#az-provider-register"><code>az provider register</code></a> command to register <em>Microsoft.ContainerService</em> as a Resource Provider:</p>

<pre><code class="language-bash">az provider register --namespace 'Microsoft.ContainerService'
</code></pre>

<p>This will take a while to execute. Check the status:</p>

<pre><code class="language-bash">az provider show --namespace Microsoft.ContainerService
</code></pre>

<p>Once the <code>"registrationState": "Registering"</code>  changes to <code>"registrationState": "Registered"</code>, the registration is complete.</p>
    
      <h3 id="24-register-microsoftcompute-as-a-resource-provider">
        
        
          2.4. Register Microsoft.Compute as a Resource Provider <a href="#24-register-microsoftcompute-as-a-resource-provider" class="anchor_heading">#</a>
        
        
      </h3>

<p>Run the <a href="https://learn.microsoft.com/cli/azure/provider?view=azure-cli-latest#az-provider-register"><code>az provider register</code></a> command to register <em>Microsoft.Compute</em> as a Resource Provider:</p>

<pre><code class="language-bash">az provider register --namespace 'Microsoft.Compute'
</code></pre>

<p>This will take a while to execute. Check the status:</p>

<pre><code class="language-bash">az provider show --namespace Microsoft.Compute
</code></pre>

<p>Once the <code>"registrationState": "Registering"</code>  changes to <code>"registrationState": "Registered"</code>, the registration is complete.</p>
    
      <h3 id="25-create-an-azure-container-registry">
        
        
          2.5. Create an Azure Container Registry <a href="#25-create-an-azure-container-registry" class="anchor_heading">#</a>
        
        
      </h3>

<p>Run the <a href="https://learn.microsoft.com/en-us/cli/azure/acr#az-acr-create"><code>az acr create</code></a> command to create an Azure Container Registry:</p>

<pre><code class="language-bash">az acr create \
   --name gdkrepo \
   --resource-group gdkguides \
   --sku Basic
</code></pre>
    
      <h3 id="26-create-an-azure-kubernetes-cluster">
        
        
          2.6. Create an Azure Kubernetes Cluster <a href="#26-create-an-azure-kubernetes-cluster" class="anchor_heading">#</a>
        
        
      </h3>

<p>Run the <a href="https://learn.microsoft.com/en-us/cli/azure/aks#az-aks-create"><code>az aks create</code></a> command to create an Azure Kubernetes Cluster:</p>

<pre><code class="language-bash">az aks create \
   --name gdkCluster \
   --resource-group gdkguides \
   --node-count 1 \
   --dns-name-prefix=gdk \
   --attach-acr gdkrepo \
   --generate-ssh-keys
</code></pre>

<p>Run <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get"><code>kubectl get nodes</code></a> to list the cluster nodes to verify the connection to your cluster:</p>

<pre><code class="language-bash">kubectl get nodes
</code></pre>

<p>The response should look like this:</p>
<pre><code>NAME                                STATUS   ROLES    AGE   VERSION
aks-nodepool1-70833750-vmss000000   Ready    &lt;none&gt;    3m   v1.29.7
</code></pre>
    
      <h3 id="27-authenticate-to-your-azure-container-registry">
        
        
          2.7. Authenticate to Your Azure Container Registry <a href="#27-authenticate-to-your-azure-container-registry" class="anchor_heading">#</a>
        
        
      </h3>

<p>Run the <a href="https://learn.microsoft.com/en-us/cli/azure/aks#az-aks-get-credentials"><code>az aks get-credentials</code></a> command to generate a <code>kubectl</code> configuration for authentication to ACR:</p>

<pre><code class="language-bash">az aks get-credentials \
   --resource-group gdkguides \
   --name gdkCluster
</code></pre>

<p>Run the <a href="https://learn.microsoft.com/en-us/cli/azure/acr?view=azure-cli-latest#az-acr-login"><code>az acr login</code></a> command to authenticate to your Azure Container Registry:</p>

<pre><code class="language-bash">az acr login --name gdkrepo
</code></pre>

<p>Alternately, login using <code>docker login</code>.</p>

<p>Run <code>az acr login</code> with the <code>--expose-token</code> flag to generate an access token, and save it in the <code>TOKEN</code> environment variable:</p>

<pre><code class="language-bash">export TOKEN=$(az acr login --name gdkrepo --expose-token --output tsv --query accessToken)
</code></pre>

<p>Then run:</p>

<pre><code class="language-bash">docker login gdkrepo.azurecr.io \
   --username 00000000-0000-0000-0000-000000000000 \
   --password-stdin &lt;&lt;&lt; $TOKEN
</code></pre>

<p>You should see <code>Login Succeeded</code> after logging in.</p>
    
      <h3 id="28-create-and-publish-container-images">
        
        
          2.8. Create and Publish Container Images <a href="#28-create-and-publish-container-images" class="anchor_heading">#</a>
        
        
      </h3>
    
      <h4 id="281-create-and-publish-a-container-image-of-the-native-users-microservice">
        
        
          2.8.1. Create and Publish a Container Image of the Native <em>Users</em> Microservice
        
        
      </h4>

<ol>
  <li>To create a container image of the native <em>users</em> microservice named “users”, run the following command from the <em>users</em> directory:
    <div id="tabs-doc11">
     <ul>
         <li class="tabs-gradle"><a href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">./gradlew :azure:dockerBuildNative</code></pre>

         <blockquote>
           <p>Note: If you encounter problems creating a container image, run the following command
           from the <em>users/build/docker/native-main/</em> directory:</p>
           <pre><code class="language-bash">docker build . -t users-azure -f DockerfileNative</code></pre>
         </blockquote>
     </div>
     <div id="maven">
         <pre><code class="language-bash">./mvnw package -Dpackaging=docker-native -Pgraalvm</code></pre>
         <blockquote>
           <p>Note: If you encounter problems creating a container image, run the following command
           from the <em>users/target/</em> directory:</p>
           <pre><code class="language-bash">docker build . -t users-azure -f Dockerfile</code></pre>
         </blockquote>
     </div>
 </div>
  </li>
  <li>Tag the image with the login server of your container registry:
    <pre><code class="language-bash"> docker tag users-azure gdkrepo.azurecr.io/users:latest
</code></pre>
  </li>
  <li>Push the image to the container registry:
    <pre><code class="language-bash"> docker push gdkrepo.azurecr.io/users:latest
</code></pre>
  </li>
</ol>
    
      <h4 id="282-create-and-publish-a-container-image-of-the-native-orders-microservice">
        
        
          2.8.2. Create and Publish a Container Image of the Native <em>Orders</em> Microservice
        
        
      </h4>

<ol>
  <li>To create a container image of the native <em>orders</em> microservice named “orders”, run the following command from the <em>orders</em> directory:
    <div id="tabs-doc12">
     <ul>
         <li class="tabs-gradle"><a href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">./gradlew :azure:dockerBuildNative</code></pre>

         <blockquote>
           <p>Note: If you encounter problems creating a container image, run the following command
           from the <em>orders/build/docker/native-main/</em> directory:</p>
           <pre><code class="language-bash">docker build . -t orders-azure -f DockerfileNative</code></pre>
         </blockquote>
     </div>
     <div id="maven">
         <pre><code class="language-bash">./mvnw package -Dpackaging=docker-native -Pgraalvm</code></pre>
         <blockquote>
           <p>Note: If you encounter problems creating a container image, run the following command
           from the <em>orders/target/</em> directory:</p>
           <pre><code class="language-bash">docker build . -t orders-azure -f Dockerfile</code></pre>
         </blockquote>
     </div>
 </div>
  </li>
  <li>Tag the image with the login server of your container registry:
    <pre><code class="language-bash"> docker tag orders-azure gdkrepo.azurecr.io/orders:latest
</code></pre>
  </li>
  <li>Push the image to the container registry:
    <pre><code class="language-bash"> docker push gdkrepo.azurecr.io/orders:latest
</code></pre>
  </li>
</ol>
    
      <h4 id="283-create-and-publish-a-container-image-of-the-native-api-gateway-microservice">
        
        
          2.8.3. Create and Publish a Container Image of the Native <em>API</em> (Gateway) Microservice
        
        
      </h4>

<ol>
  <li>To create a container image of the native <em>api</em> microservice named “api”, run the following command from the <em>api</em> directory:
    <div id="tabs-doc13">
     <ul>
         <li class="tabs-gradle"><a href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">./gradlew :azure:dockerBuildNative</code></pre>

         <blockquote>
           <p>Note: If you encounter problems creating a container image, run the following command
           from the <em>api/build/docker/native-main/</em> directory:</p>
           <pre><code class="language-bash">docker build . -t api-azure -f DockerfileNative</code></pre>
         </blockquote>
     </div>
     <div id="maven">
         <pre><code class="language-bash">./mvnw package -Dpackaging=docker-native -Pgraalvm</code></pre>
         <blockquote>
           <p>Note: If you encounter problems creating a container image, run the following command
           from the <em>api/target/</em> directory:</p>
           <pre><code class="language-bash">docker build . -t api-azure -f Dockerfile</code></pre>
         </blockquote>
     </div>
 </div>
  </li>
  <li>Tag the image with the login server of your container registry:
    <pre><code class="language-bash"> docker tag api-azure gdkrepo.azurecr.io/api:latest
</code></pre>
  </li>
  <li>Push the image to the container registry:
    <pre><code class="language-bash"> docker push gdkrepo.azurecr.io/api:latest
</code></pre>
  </li>
</ol>
    
      <h3 id="29-update-the-kubernetes-manifest-files">
        
        
          2.9. Update the Kubernetes Manifest Files <a href="#29-update-the-kubernetes-manifest-files" class="anchor_heading">#</a>
        
        
      </h3>
    
      <h4 id="291-update-the-users-manifest-file">
        
        
          2.9.1. Update the <em>Users</em> Manifest File
        
        
      </h4>

<p>Edit the file named <em>users/k8s-azure.yml</em> as follows:</p>

<pre><code class="language-yml">apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: gdk-k8s
  name: users
spec:
  selector:
    matchLabels:
      app: users
  template:
    metadata:
      labels:
        app: users
    spec:
      serviceAccountName: gdk-service
      containers:
        - name: users
          image: 'gdkrepo.azurecr.io/users:latest' # &lt;1&gt;
          imagePullPolicy: Always # &lt;2&gt;
          ports:
            - name: http
              containerPort: 8080
          readinessProbe:
            httpGet:
              path: /health/readiness
              port: 8080
            initialDelaySeconds: 5
            timeoutSeconds: 3
          livenessProbe:
            httpGet:
              path: /health/liveness
              port: 8080
            initialDelaySeconds: 5
            timeoutSeconds: 3
            failureThreshold: 10
          env:
            - name: MICRONAUT_ENVIRONMENTS
              value: azure
---
apiVersion: v1
kind: Service
metadata:
  namespace: gdk-k8s
  name: users
spec:
  selector:
    app: users
  type: NodePort
  ports:
    - protocol: TCP
      port: 8080
</code></pre>

<p><strong>1</strong> The location of the image that you created in ACR</p>

<p><strong>2</strong> Change <code>imagePullPolicy</code> to <code>Always</code>.</p>
    
      <h4 id="292-update-the-orders-manifest-file">
        
        
          2.9.2. Update the <em>Orders</em> Manifest File
        
        
      </h4>

<p>Edit the file named <em>orders/k8s-azure.yml</em> as follows:</p>

<pre><code class="language-yml">apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: gdk-k8s
  name: orders
spec:
  selector:
    matchLabels:
      app: orders
  template:
    metadata:
      labels:
        app: orders
    spec:
      serviceAccountName: gdk-service
      containers:
        - name: orders
          image: 'gdkrepo.azurecr.io/orders:latest' # &lt;1&gt;
          imagePullPolicy: Always # &lt;2&gt;
          ports:
            - name: http
              containerPort: 8080
          readinessProbe:
            httpGet:
              path: /health/readiness
              port: 8080
            initialDelaySeconds: 5
            timeoutSeconds: 3
          livenessProbe:
            httpGet:
              path: /health/liveness
              port: 8080
            initialDelaySeconds: 5
            timeoutSeconds: 3
            failureThreshold: 10
          env:
            - name: MICRONAUT_ENVIRONMENTS
              value: azure
---
apiVersion: v1
kind: Service
metadata:
  namespace: gdk-k8s
  name: orders
spec:
  selector:
    app: orders
  type: NodePort
  ports:
    - protocol: TCP
      port: 8080
</code></pre>

<p><strong>1</strong> The location of the image that you created in ACR</p>

<p><strong>2</strong> Change <code>imagePullPolicy</code> to <code>Always</code>.</p>
    
      <h4 id="293-update-the-api-manifest-file">
        
        
          2.9.3. Update the <em>API</em> Manifest File
        
        
      </h4>

<p>Edit the file named <em>api/k8s-azure.yml</em> as follows:</p>

<pre><code class="language-yml">apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: gdk-k8s
  name: api
spec:
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
    spec:
      serviceAccountName: gdk-service
      containers:
        - name: api
          image: 'gdkrepo.azurecr.io/api:latest' # &lt;1&gt;
          imagePullPolicy: Always # &lt;2&gt;
          ports:
            - name: http
              containerPort: 8080
          readinessProbe:
            httpGet:
              path: /health/readiness
              port: 8080
            initialDelaySeconds: 5
            timeoutSeconds: 3
          livenessProbe:
            httpGet:
              path: /health/liveness
              port: 8080
            initialDelaySeconds: 5
            timeoutSeconds: 3
            failureThreshold: 10
          env:
            - name: MICRONAUT_ENVIRONMENTS
              value: azure
---
apiVersion: v1
kind: Service
metadata:
  namespace: gdk-k8s
  name: api
spec:
  selector:
    app: api
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 8080
</code></pre>

<p><strong>1</strong> The location of the image that you created in ACR</p>

<p><strong>2</strong> Change <code>imagePullPolicy</code> to <code>Always</code>.</p>
    
      <h2 id="3-deploy-microservices-to-aks">
        
        
          3. Deploy Microservices to AKS <a href="#3-deploy-microservices-to-aks" class="anchor_heading">#</a>
        
        
      </h2>

<ol>
  <li>
    <p>Deploy the <em>auth.yml</em> file that specifies service roles and secrets:</p>

    <pre><code class="language-bash"> kubectl apply -f auth.yml
</code></pre>
  </li>
  <li>
    <p>Deploy the <em>users</em> microservice:</p>

    <pre><code class="language-bash"> kubectl apply -f users/k8s-azure.yml
</code></pre>
  </li>
  <li>
    <p>Deploy the <em>orders</em> microservice:</p>

    <pre><code class="language-bash"> kubectl apply -f orders/k8s-azure.yml
</code></pre>
  </li>
  <li>
    <p>Deploy the <em>api</em> microservice:</p>

    <pre><code class="language-bash"> kubectl apply -f api/k8s-azure.yml
</code></pre>
  </li>
</ol>
    
      <h2 id="4-test-integration-between-the-microservices-deployed-to-aks">
        
        
          4. Test Integration Between the Microservices Deployed to AKS <a href="#4-test-integration-between-the-microservices-deployed-to-aks" class="anchor_heading">#</a>
        
        
      </h2>

<ol>
  <li>Run the following command to check the status of the pods and make sure that all of them have the status “Running”:
    <pre><code class="language-bash"> kubectl get pods -n=gdk-k8s
</code></pre>

    <pre>
 NAME                      READY   STATUS    RESTARTS   AGE
 api-6fb4cd949f-kxxx8      1/1     Running   0          12s
 orders-595887ddd6-6lzp4   1/1     Running   0          17s
 users-df6f78cd7-lgnzx     1/1     Running   0          23s</pre>
  </li>
  <li>
    <p>Run this command to check the status of the microservices:</p>

    <pre><code class="language-bash"> kubectl get services -n=gdk-k8s
</code></pre>

    <pre>
 NAME         TYPE           CLUSTER-IP       EXTERNAL-IP             PORT(S)             AGE
 api          LoadBalancer   10.100.208.154   &lt;redacted&gt;              8080:31171/TCP      31s
 orders       NodePort       10.100.157.155   &lt;none&gt;                  8080:30742/TCP      36s
 users        NodePort       10.100.126.97    &lt;none&gt;                  8080:31580/TCP      42s</pre>

    <p>If <code>EXTERNAL-IP</code> is in a <code>&lt;pending&gt;</code> state, wait a couple of seconds and then run the command again.</p>
  </li>
  <li>
    <p>Retrieve the URL of the <em>api</em> microservice and set it as the value of the <code>$API_URL</code> environment variable:</p>

    <pre><code class="language-bash"> export API_URL=http://$(kubectl get svc api -n=gdk-k8s -o json | jq -r '.status.loadBalancer.ingress[0].ip'):8080
</code></pre>
  </li>
  <li>
    <p>Run a <code>curl</code> command to create a new user via the <em>api</em> microservice:</p>

    <pre><code class="language-bash"> curl -X "POST" "$API_URL/api/users" \
      -H 'Content-Type: application/json; charset=utf-8' \
      -d '{ "first_name": "Nemanja", "last_name": "Mikic", "username": "nmikic" }'
</code></pre>

    <p>Your output should look like:</p>

    <pre><code class="language-json"> {
   "id":1,
   "username":"nmikic",
   "first_name":"Nemanja",
   "last_name":"Mikic"
 }
</code></pre>
  </li>
  <li>
    <p>Run a <code>curl</code> command to create a new order via the <em>api</em> microservice:</p>

    <pre><code class="language-bash"> curl -X "POST" "$API_URL/api/orders" \
      -H 'Content-Type: application/json; charset=utf-8' \
      -d '{ "user_id": 1, "item_ids": [1,2] }'
</code></pre>

    <p>Your output should include details of the order, as follows:</p>

    <pre><code class="language-json"> {
   "id": 1,
   "user": {
     "first_name": "Nemanja",
     "last_name": "Mikic",
     "id": 1,
     "username": "nmikic"
   },
   "items": [
     {
       "id": 1,
       "name": "Banana",
       "price": 1.5
     },
     {
       "id": 2,
       "name": "Kiwi",
       "price": 2.5
     }
   ],
   "total": 4.0
 }
</code></pre>
  </li>
  <li>
    <p>Run a <code>curl</code> command to list the orders:</p>

    <pre><code class="language-bash"> curl "$API_URL/api/orders" \
      -H 'Content-Type: application/json; charset=utf-8'
</code></pre>

    <p>You should see output that is similar to the following:</p>

    <pre><code class="language-json"> [
   {
     "id": 1,
     "user": {
       "first_name": "Nemanja",
       "last_name": "Mikic",
       "id": 1,
       "username": "nmikic"
     },
     "items": [
       {
         "id": 1,
         "name": "Banana",
         "price": 1.5
       },
       {
         "id": 2,
         "name": "Kiwi",
         "price": 2.5
       }
     ],
     "total": 4.0
   }
 ]
</code></pre>
  </li>
  <li>
    <p>Try to place an order for a user who does not exist (with <code>id</code> 100). Run a <code>curl</code> command:</p>

    <pre><code class="language-bash"> curl -X "POST" "$API_URL/api/orders" \
      -H 'Content-Type: application/json; charset=utf-8' \
      -d '{ "user_id": 100, "item_ids": [1,2] }'
</code></pre>

    <p>You should see the following error message:</p>

    <pre><code class="language-json"> {
   "message": "Bad Request",
   "_links": {
     "self": [
       {
         "href": "/api/orders",
         "templated": false
       }
     ]
   },
   "_embedded": {
     "errors": [
       {
         "message": "User with id 100 doesn't exist"
       }
     ]
   }
 }
</code></pre>
  </li>
</ol>
    
      <h2 id="7-clean-up-cloud-resources">
        
        
          7. Clean up Cloud Resources <a href="#7-clean-up-cloud-resources" class="anchor_heading">#</a>
        
        
      </h2>

<p>Once you are done with this guide, you can delete the Azure resources created to avoid incurring unnecessary charges.</p>

<p>Delete the resource group and all of its resources with:</p>
<pre><code class="language-bash">az group delete --name gdkguides
</code></pre>

<p>Alternatively, run these commands to delete resources individually:</p>

<pre><code class="language-bash">kubectl delete namespaces gdk-k8s
</code></pre>

<pre><code class="language-bash">az aks delete --name gdkCluster --resource-group gdkguides
</code></pre>

<pre><code class="language-bash">az acr delete --name gdkrepo
</code></pre>

<pre><code class="language-bash">az group delete --name gdkguides
</code></pre>
    
      <h3 id="summary">
        
        
          Summary <a href="#summary" class="anchor_heading">#</a>
        
        
      </h3>

<p>This guide demonstrated how to use Kubernetes Service Discovery and Distributed Configuration, provided with the Micronaut Kubernetes integration, to connect three microservices, and to deploy these microservices to a Kubernetes cluster in the Azure Kubernetes Service.</p>
    
      <h3 id="related-documentation">
        
        
          Related Documentation <a href="#related-documentation" class="anchor_heading">#</a>
        
        
      </h3>

<ul>
  <li><a href="https://micronaut-projects.github.io/micronaut-kubernetes/latest/guide/">Micronaut Kubernetes module</a></li>
  <li><a href="https://learn.microsoft.com/en-us/azure/aks/what-is-aks">Azure Kubernetes Service (AKS)</a></li>
</ul>

      </div>

      <div role="button" class="menu-btn menu-btn--sidebar js-show-sidebar" title="sweet hamburger">
        <div class="hamburger">
          <div class="inner"></div>
        </div>
      </div>
    </div>
  </div>
</article>



</div>

      </main>

      
<footer class="footer footer__mobile">

  <div class="container-fluid container-fluid--custom-sm">
    <div class="row">
      <div class="col-12 col-sm-12 col-md-12 col-lg-12">
        <div class="row footer-content">
          <div class="col-md-3 col-sm-4">
            <h6 class="title-footer" onclick="fadeInAndOut(this)">Learn</h6>
            <div class="grow">
              <ul class="footer-list">
                <li class="footer-list__item"><a href="/gdk/get-started/">Get Started</a></li>
                <li class="footer-list__item"><a href="/gdk/guides/">Guides</a></li>
                <li class="footer-list__item"><a href="/gdk/hands-on-labs/">Labs</a></li>
                <li class="footer-list__github">
                  <img class="footer__icon" src="/gdk/resources/img/footer/logo-github.svg" alt="Github icon">
                  <a href="https://github.com/oracle/graal-dev-kit" target="blank">Github</a>
                </li>
                <li class="footer-list__github">
                  <img class="footer__icon" src="/gdk/resources/img/footer/slack-icon.svg" alt="Github icon">
                  <a href="https://bit.ly/odevrel_slack" target="blank">#graal-dev-kit-for-micronaut</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-md-3 col-sm-4">
            <h6 class="title-footer" onclick="fadeInAndOut(this)">About</h6>
            <div class="grow">
              <ul class="footer-list">
                <li class="footer-list__item"><a href="/gdk/about/#gdk-support" target="blank">Commercial Support</a></li>
                <li class="footer-list__item"><a href="https://www.graalvm.org/" target="blank">GraalVM Native Image</a></li>
                <li class="footer-list__item"><a href="https://micronaut.io/" target="_blank">Micronaut<sup>&reg;</sup> Framework</a></li>
                <li class="footer-list__item"><a href="https://www.oracle.com/cloud/multicloud/what-is-multicloud/" target="_blank">Multicloud</a></li>
                <li class="footer-list__item"><a href="https://www.oracle.com/cloud/" target="blank">Oracle Cloud Infrastructure</a></li>
                <li class="footer-list__item"><a href="https://marketplace.visualstudio.com/items?itemName=oracle-labs-graalvm.graal-cloud-native-pack" target="blank">VS Code Tools</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md-6 col-sm-12 aligning_1024">
            <div class="card--footer card--hovered box">
              <div>
                <div class="rubber-footer footer__oci-section">
                  <p class="title-footer quickstart">Build, test, and deploy applications on Oracle Cloud Infrastructure for free</p>
                  <a href="https://www.oracle.com/cloud/free/" target="_blank"
                    class="btn btn-primary">Try Oracle Cloud Infrastructure Free Tier</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
          <div class="row">
            <div class="col-sm-12">
              <p class="copyright">
                Copyright &copy; 2023-2024, Oracle and/or its affiliates.
                All rights reserved.
                Oracle and Java are registered trademarks of Oracle and/or its affiliates.<br/>
                Micronaut<sup>&reg;</sup> is a registered trademark of Object Computing, Inc.
                Use is for referential purposes and does not imply any endorsement or affiliation with any third-party product.
                Unauthorized use is strictly prohibited. Other names may be trademarks of their respective owners.
              </p>
              <div id="teconsent"></div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</footer>

<script>
  function fadeInAndOut(thz) {
    var elmt = thz.nextElementSibling;//Get the element that is below the button that
    //was just clicked
    if (elmt.clientHeight) {
      elmt.style.height = 0;
    } else {
      var wrapper = elmt.querySelector('ul');
      elmt.style.height = wrapper.clientHeight + "px";
    }
    /*
        elmt.classList.toggle("acordianPanelHidden");//Toggle the class which changes
        //attributes which triggers the transition CSS
        */
  }

  // Check TRUSTe Consent for Functional or Implied Approval
  // The if test verifies if the user has given the consent
  if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
      (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
        oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(2) != -1) ) {

      //The following is a sample of a Maxymiser Tag being written to the DOM
      //If the user did not give consent, then the tag is not included and not invoked in the Browser
      document.write('<script type="text/javascript" src="//service.maxymiser.net/cdn/oracle/js/mmcore.js"><\/script>');
  }

  // Check TRUSTe Consent for Advertising or Implied Approval
  // The if test verifies if the user has given the consent
  if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
      (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
        oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(3) != -1) ) {

      //The following is a sample of a BlueKai Core Tag being written to the DOM
      //If the user did not give consent, then the tag is not included and not invoked in the Browser
      document.write('<script type="text/javascript">' +
      'window.bk_async = function() { ' +
      'BKTAG.doTag(62581, 1); }; ' +
      '(function() { ' +
      'var scripts = document.getElementsByTagName(\'script\')[0]; ' +
      'var s = document.createElement(\'script\'); ' +
      's.async = true; ' +
      's.src = "https://tags.bkrtx.com/js/bk-coretag.js"; ' +
      'scripts.parentNode.insertBefore(s, scripts); ' +
      '}()); ' +
      '<\/script>');
  }
</script>

    </div>
    <div class="overlay"></div>

    <!-- Start SiteCatalyst code -->
    <script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script>
    <!-- End SiteCatalyst code -->

    <script src='/gdk/resources/lib/slick-slider/slick.min.js'></script>
    <script src='/gdk/resources/js/main.js'></script>
    <script src='/gdk/resources/js/ui.js'></script>
    <script src='/gdk/resources/js/filters.js'></script>
    <script src='/gdk/resources/js/sidebar.js'></script>
    <script src='/gdk/resources/js/labs.js'></script>
    <script src='/gdk/resources/lib/highlight/highlight.min.js'></script>
    <script>hljs.highlightAll();</script>
  </body>
</html>
