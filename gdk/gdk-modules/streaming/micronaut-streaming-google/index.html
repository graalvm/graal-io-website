<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="/gdk/resources/img/graalvm.png" />
  <meta name="twitter:widgets:border-color" content="#55acee">

  <title>
    
      Create and Deploy a Streaming Application with Google Cloud Platform Apache Kafka
    
  </title>
  <meta name="description" content="The Graal Development Kit for Micronaut (GDK) is a build of a curated set of Micronaut framework modules and their required libraries for building portable c..."/>
  <meta name="last_modified" content="2024-09-25 16:23:53 +0000"/>
  <meta name="last_built" content="2024-12-06 14:26:04 +0000"/>
  <link rel="stylesheet" href="/gdk/assets/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/gdk/resources/img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/gdk/resources/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/gdk/resources/img/favicon/favicon-16x16.png">
  <link rel="manifest" href="/gdk/resources/img/favicon/site.webmanifest">
  <link rel="stylesheet" type="text/css" href="/gdk/resources/styles/codicon.css" />
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="-vRqwa9WYn6AaQGnl88xvrLw6ac4xoKVkZkhanmlRhU" />
  <link rel="canonical" href="https://www.graal.cloud/gdk/gdk-modules/streaming/micronaut-streaming-google/">

  <!-- jQuery UI Tabs -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/gdk/resources/lib/jquery/jquery-ui.css">
</head>

      <script src="/gdk/resources/lib/jquery/jquery-3.7.1.min.js"></script>
    <script src="/gdk/resources/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src='/gdk/resources/lib/sticky-sidebar/resizeSensor.js'></script>
    <script src='/gdk/resources/lib/sticky-sidebar/sticky-sidebar.min.js'></script>
    <script src="/gdk/resources/lib/highlight/highlight.min.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Add TRUSTe Consent Script and Analytics -->
    <script async="async" type="text/javascript" src='//consent.trustarc.com/notice?domain=oracle.com&c=teconsent&js=bb&noticeType=bb&text=true&cdn=1&pcookie&gtm=1' crossorigin></script>
    <script src="https://www.oracle.com/assets/truste-oraclelib.js"></script>
    <!-- jQuery UI Tabs -->
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>


  <body class="preload">
    <!-- Start SiteCatalyst code -->
    <script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script>
    <!-- End SiteCatalyst code -->

    <div  class="wrapper wrapper--nofooter" >

      <header  class="header header--content" 
  role="banner">

  

  

    <nav class="menu">
      <div class="menu__row">
        <div>
          <a href="/gdk/">
            <img class="logo-mobile" src="/gdk/resources/img/gdk-logo-new.svg" alt="Graal Development Kit for Micronaut logo">
          </a>
        </div>
        <div class="menu__container">
          <ul class="menu__list">
            <li class="menu__item">
              <a href="/gdk/about/" class="menu__link">About</a>
            </li>
            <li class="menu__item">
              <a href="/gdk/get-started/" class="menu__link">Get Started</a>
            </li>
            <li class="menu__item">
              <div class="stack-container">
                <a href="#" class="menu__link stack__header">Docs</a>
                <div class="stack-menu-learn">
                  <div class="stack-row">
                    <div class="stack-column">
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/modules.svg'>
                        <a href="/gdk/modules/" class="item-line">Modules</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/guides.svg'>
                        <a href="/gdk/guides/" class="item-line">Guides</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/labs.svg'>
                        <a href="/gdk/hands-on-labs/" class="item-line">Hands-On Labs</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/tools.svg'>
                        <a href="/gdk/vscode-tools/" class="item-line">Tools</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <li class="menu__item">
              <div class="stack-container">
                <a href="#" class="menu__link stack__header">Graal Projects</a>
                <div class="stack-menu">
                  <div class="stack-row">
                    <div class="stack-column">
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalstack.svg'>
                        <a href="https://graal.cloud/" class="item-line">Graal</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalvm.svg'>
                        <a href="https://graalvm.org/" class="item-line">GraalVM</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalos.svg'>
                        <a href="https://graal.cloud/graalos/" class="item-line">GraalOS</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <li class="menu__launch__mobile">
              <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
            </li>
          </ul>
        </div>
        <div class="menu__launch">
          <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
        </div>
      </div>

      <div role="button" class="menu-btn menu-btn--menu js-show-menu" tabindex="-1" title="sweet hamburger">
        <div class="hamburger">
          <div class="inner"></div>
        </div>
      </div>
      <button aria-label="hamburger mobile menu" class="btn btn-mobile-menu js-show-menu">
        <div class="inner"></div>
      </button>
    </nav>

  
</header>


      <main  class="content"   aria-label="Content">
        <div class="wrapper wrapper-content">
  <article>
  <div class="row d-flex flex-wrap">
    <div class="col-sm-3 docsimpro col-bg">
      <div class="sidebar-wrap">
        <div class="sidebar">
          <div class="menuabout">
            <img id="sidebarClose" src="/gdk/resources/img/arrow_sidebar(close).svg" alt="Expand or collapse sidebar"
              class="btn-color no-display">
            <img id="sidebarOpen" src="/gdk/resources/img/arrow_sidebar.svg" alt="Expand or collapse sidebar">
          </div>
          
<div class="toc-floating">


<div class="toc-bullets">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    

    
      
        
          <li class="toc-bullets-main">
        
          
          <a href="/gdk/docs/gdk-modules/streaming/" class="_icon-book">
            Streaming
          </a>
        </li>

        
        

        
        
          
          <li class="toc-bullets-sub toc-bullets-highlight">
          
            
            <a href="/gdk/gdk-modules/streaming/micronaut-streaming-google/">
              Create and Deploy a Streaming Application with Google Cloud Platform Apache Kafka
            </a>
          </li>

          
            <div>
  <script>
    var scriptElement = document.currentScript;
    var div = $(scriptElement.parentElement);
    $(window).on("load", function () {
      $("#content-wrapper h2").each(function () {
        var li = $("<li></li>", { class: "toc-bullets-sub toc-bullets-sub-3" });
        var a = $("<a></a>", { href: "#" + $(this).attr("id") });
        a.text($(this).text().replace('#', ''));
        li.append(a);
        li.click(function (e) {
          e.preventDefault();
          var target = $(a.attr('href'));
          var scrollTo = target.offset().top - 80; // 80 - indent
          $('html, body').animate({ scrollTop: scrollTo }, 1000);
        });
        div.append(li);
      });
    });
  </script>
</div>
          
        
      
    
  

  

  

  

  

  

  

  

  

  

  

  

<!-- <li class="search additional-search">
  <form class="form-inline sidebar" action="/docs/search" autocomplete="on" method="get">
    <input class="input-search sidebar" type="text" id="search-box" name="query" placeholder="Search">
    <button type="submit sidebar" class="search-button"></button>
  </form>
</li> -->

</div>
  <!-- Search form -->
  <!-- <form class="search-container" action="/docs/search" autocomplete="on" method="get">
   <label for="search-box">Search</label>
    <input type="text" id="search-box" name="query">
    <button type="submit" class="searchbttn"></button>
  </form> -->
</div>

        </div>
      </div>
    </div>

    <div class="col-sm-9 docsmod">
      <div id="content-wrapper" class="docs-content docs-content--with-sidebar">
        <!--
          Include file to warn of Windows/Gradle restriction
        -->
        <h1 id="create-and-deploy-a-streaming-application-with-google-cloud-platform-apache-kafka">
        
        
          Create and Deploy a Streaming Application with Google Cloud Platform Apache Kafka
        
        
      </h1>

<p>This guide describes how to use the Graal Development Kit for Micronaut (GDK) to create a streaming application that uses <a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Micronaut<sup>®</sup> Streaming</a>and <a href="https://cloud.google.com/learn/what-is-apache-kafka">Google Cloud Platform Apache Kafka</a>.
The application consists of two Micronaut microservices that use Google Cloud Platform Apache Kafka to communicate with each other in an asynchronous and decoupled way.</p>
    
      <h3 id="prerequisites">
        
        
          Prerequisites <a href="#prerequisites" class="anchor_heading">#</a>
        
        
      </h3>

<ul>
  <li>JDK 17 or higher. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>.</li>
  <li>A Google Cloud Platform (GCP) account. See <a href="/gdk/get-started/setting-up-cloud-accounts/">Setting up Your Cloud Accounts</a>.</li>
  <li>The Google Cloud CLI. (The CLI is part of the Google Cloud SDK; for more information, see <a href="https://cloud.google.com/sdk">Cloud SDK</a>.)</li>
  <li>A Docker-API compatible container runtime such as <a href="https://docs.rancherdesktop.io/getting-started/installation/">Rancher Desktop</a> or <a href="https://www.docker.io/gettingstarted/">Docker</a> installed.</li>
  <li>The GDK CLI. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>. (Optional.)</li>
</ul>

<blockquote>
  <p>Note: This guide uses paid services; you may need to <a href="https://cloud.google.com/billing/docs/how-to/modify-project">enable billing</a> in Google Cloud to complete some steps in this guide.</p>
</blockquote>

<p>Follow the steps below to create the application from scratch. However, you can also download the completed example:</p>

<div id="tabs-doc1">
  <ul>
    <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <p><a href="https://github.com/oracle/graal-dev-kit/releases/download/4.6.0.6/4.6.0.6_streaming_gcp-streaming-demo-java-gradle.zip">Gradle GCP Streaming Example <img class="download-img-guides" src="/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" /></a>
    </p>
  </div>
  <div id="maven">
    <p><a href="https://github.com/oracle/graal-dev-kit/releases/download/4.6.0.6/4.6.0.6_streaming_gcp-streaming-demo-java-maven.zip">Maven GCP Streaming Example <img class="download-img-guides" src="/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" /></a>
    </p>
  </div>
</div>
    
      <h4 id="a-note-regarding-your-development-environment">
        
        
          A note regarding your development environment
        
        
      </h4>

<p>Consider using Visual Studio Code, which provides native support for developing applications with the <a href="/gdk/vscode-tools/using-gdk-vscode-tools/">Graal Development Kit extension</a>.</p>

<p>If you use IntelliJ IDEA, <a href="/gdk/resources/img/annotationprocessorsintellij.png">enable annotation processing</a>.</p>

<blockquote>
  <p>Windows platform: The GDK guides are compatible with Gradle only. Maven support is coming soon.</p>
</blockquote>
    
      <h2 id="1-create-the-microservices">
        
        
          1. Create the Microservices <a href="#1-create-the-microservices" class="anchor_heading">#</a>
        
        
      </h2>

<p>The two microservices are:</p>

<ul>
  <li><em>Books</em> returns a list of books. It uses a domain consisting of a book name and an International Standard Book Number (ISBN). It also publishes a message to the streaming service every time a book is accessed.</li>
  <li><em>Analytics</em> connects to the streaming service to update the analytics for every book (a counter). It also exposes an endpoint to retrieve the counter.</li>
</ul>
    
      <h3 id="11-create-the-books-microservice">
        
        
          1.1. Create the <em>Books</em> Microservice <a href="#11-create-the-books-microservice" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Open the <a href="/gdk/launcher/?advanced=true">GDK Launcher in advanced mode</a>.</p>
  </li>
  <li>Create a new project using the following selections.
    <ul>
      <li><strong>Project Type</strong>: <em>Application</em> (Default)</li>
      <li><strong>Project Name</strong>: <em>books</em></li>
      <li><strong>Base Package</strong>: <em>com.example.publisher</em></li>
      <li><strong>Clouds</strong>: <em>GCP</em></li>
      <li><strong>Build Tool</strong>: <em>Gradle (Groovy)</em> or <em>Maven</em></li>
      <li><strong>Language</strong>: <em>Java</em> (Default)</li>
      <li><strong>Test Framework</strong>: <em>JUnit</em> (Default)</li>
      <li><strong>Java Version</strong>: <em>17</em> (Default)</li>
      <li><strong>Micronaut Version</strong>: (Default)</li>
      <li><strong>Cloud Services</strong>: <em>Streaming</em></li>
      <li><strong>Features</strong>: <em>Awaitility Framework</em>, <em>GraalVM Native Image</em>, <em>Micronaut Serialization Jackson Core</em>, and <em>Reactor</em></li>
      <li><strong>Sample Code</strong>: <em>No</em></li>
    </ul>
  </li>
  <li>Click <strong>Generate Project</strong>, then click <strong>Download Zip</strong>. The GDK Launcher creates an application with the default package <code>com.example.publisher</code> in a directory named <em>books</em>. The application ZIP file will be downloaded to your default downloads directory. Unzip it, open it in your code editor, and proceed to the next steps.</li>
</ol>

<p>Alternatively, use the <a href="/gdk/get-started/using-gdk-cli/">GDK CLI</a> as follows:</p>

<div id="tabs-doc2">
  <ul>
    <li class="tabs-gradle"><a href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <pre><code class="language-bash">gdk create-app com.example.publisher.books \
    --clouds=gcp \
    --services=streaming \
    --features=awaitility,graalvm,reactor,serialization-jackson \
    --build=gradle \
    --jdk=17 \
    --lang=java \
    --example-code=false</code></pre>
  </div>
  <div id="maven">
    <pre><code class="language-bash">gdk create-app com.example.publisher.books \
    --clouds=gcp \
    --services=streaming \
    --features=awaitility,graalvm,reactor,serialization-jackson \
    --build=maven \
    --jdk=17 \
    --lang=java \
    --example-code=false</code></pre>
  </div>
</div>
    
      <h4 id="111-book-domain-class">
        
        
          1.1.1. Book Domain Class
        
        
      </h4>

<p>The GDK Launcher created a <code>Book</code> domain class in a file named <em>lib/src/main/java/com/example/publisher/Book.java</em>, as follows:</p>

<pre><code class="language-java">package com.example.publisher;

import io.micronaut.core.annotation.Creator;
import io.micronaut.serde.annotation.Serdeable;

import java.util.Objects;

@Serdeable
public class Book {

    private final String isbn;
    private final String name;

    @Creator
    public Book(String isbn, String name) {
        this.isbn = isbn;
        this.name = name;
    }

    public String getIsbn() {
        return isbn;
    }

    public String getName() {
        return name;
    }

    @Override
    public String toString() {
        return "Book{" +
                "isbn='" + isbn + '\'' +
                ", name='" + name + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Book other = (Book) o;
        return Objects.equals(isbn, other.isbn) &amp;&amp;
                Objects.equals(name, other.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(isbn, name);
    }
}
</code></pre>
    
      <h4 id="112-bookservice">
        
        
          1.1.2. BookService
        
        
      </h4>

<p>To keep this guide simple there is no database persistence: the <em>Books</em> microservice keeps the list of books in memory. The GDK Launcher created a class named <code>BookService</code> in <em>lib/src/main/java/com/example/publisher/BookService.java</em> with the following contents:</p>

<pre><code class="language-java">package com.example.publisher;

import jakarta.annotation.PostConstruct;
import jakarta.inject.Singleton;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Singleton
public class BookService {

    private final List&lt;Book&gt; bookStore = new ArrayList&lt;&gt;();

    @PostConstruct
    void init() {
        bookStore.add(new Book("1491950358", "Building Microservices"));
        bookStore.add(new Book("1680502395", "Release It!"));
        bookStore.add(new Book("0321601912", "Continuous Delivery"));
    }

    public List&lt;Book&gt; listAll() {
        return bookStore;
    }

    public Optional&lt;Book&gt; findByIsbn(String isbn) {
        return bookStore.stream()
                .filter(b -&gt; b.getIsbn().equals(isbn))
                .findFirst();
    }
}
</code></pre>
    
      <h4 id="113-bookcontroller">
        
        
          1.1.3. BookController
        
        
      </h4>

<p>The GDK Launcher created a controller to access <code>Book</code> instances in a file named <em>lib/src/main/java/com/example/publisher/BookController.java</em> with the following contents:</p>

<pre><code class="language-java">package com.example.publisher;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;

import java.util.List;
import java.util.Optional;

@Controller("/books") // &lt;1&gt;
class BookController {

    private final BookService bookService;

    BookController(BookService bookService) { // &lt;2&gt;
        this.bookService = bookService;
    }

    @Get // &lt;3&gt;
    List&lt;Book&gt; listAll() {
        return bookService.listAll();
    }

    @Get("/{isbn}") // &lt;4&gt;
    Optional&lt;Book&gt; findBook(String isbn) {
        return bookService.findByIsbn(isbn);
    }
}
</code></pre>

<p><strong>1</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html"><code>@Controller</code></a> annotation defines the class as a controller mapped to the root URI <code>/books</code>.</p>

<p><strong>2</strong> Use constructor injection to inject a bean of type <code>BookService</code>.</p>

<p><strong>3</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>listAll</code> method to an HTTP GET request on <code>/books</code>.</p>

<p><strong>4</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>findBook</code> method to an HTTP GET request on <code>/books/{isbn}</code>.</p>
    
      <h4 id="114-bookcontrollertest">
        
        
          1.1.4. BookControllerTest
        
        
      </h4>

<p>The GDK Launcher created a test for <code>BookController</code> to verify the interaction with the <em>Analytics</em> microservice in a file named <em>gcp/src/test/java/com/example/publisher/BookControllerTest.java</em> with the following contents:</p>

<pre><code class="language-java">package com.example.publisher;

import io.micronaut.configuration.kafka.annotation.KafkaListener;
import io.micronaut.configuration.kafka.annotation.Topic;
import io.micronaut.core.type.Argument;
import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.HttpClient;
import io.micronaut.http.client.annotation.Client;
import io.micronaut.http.client.exceptions.HttpClientResponseException;
import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestInstance;

import jakarta.inject.Inject;
import java.util.Collection;
import java.util.Optional;
import java.util.concurrent.ConcurrentLinkedDeque;

import static io.micronaut.configuration.kafka.annotation.OffsetReset.EARLIEST;
import static java.util.concurrent.TimeUnit.SECONDS;
import static org.awaitility.Awaitility.await;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.TestInstance.Lifecycle.PER_CLASS;

@MicronautTest
@TestInstance(PER_CLASS) // &lt;1&gt;
class BookControllerTest {

    private static final Collection&lt;Book&gt; received = new ConcurrentLinkedDeque&lt;&gt;();

    @Inject
    AnalyticsListener analyticsListener; // &lt;2&gt;

    @Inject
    @Client("/")
    HttpClient client; // &lt;3&gt;

    @Test
    void testMessageIsPublishedToKafkaWhenBookFound() {
        String isbn = "1491950358";

        Optional&lt;Book&gt; result = retrieveGet("/books/" + isbn); // &lt;4&gt;
        assertNotNull(result);
        assertTrue(result.isPresent());
        assertEquals(isbn, result.get().getIsbn());

        await().atMost(5, SECONDS).until(() -&gt; !received.isEmpty()); // &lt;5&gt;

        assertEquals(1, received.size()); // &lt;6&gt;
        Book bookFromKafka = received.iterator().next();
        assertNotNull(bookFromKafka);
        assertEquals(isbn, bookFromKafka.getIsbn());
    }

    @Test
    void testMessageIsNotPublishedToKafkaWhenBookNotFound() throws Exception {
        assertThrows(HttpClientResponseException.class, () -&gt; {
            retrieveGet("/books/INVALID");
        });

        Thread.sleep(5_000); // &lt;7&gt;
        assertEquals(0, received.size());
    }

    @AfterEach
    void cleanup() {
        received.clear();
    }

    @KafkaListener(offsetReset = EARLIEST)
    static class AnalyticsListener {

        @Topic("analytics")
        void updateAnalytics(Book book) {
            received.add(book);
        }
    }

    private Optional&lt;Book&gt; retrieveGet(String url) {
        return client.toBlocking().retrieve(HttpRequest.GET(url), Argument.of(Optional.class, Book.class));
    }
}
</code></pre>

<p><strong>1</strong> Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests.</p>

<p><strong>2</strong> Dependency injection for the <code>AnalyticsListener</code> class declared later in the file. This is a listener class that replicates the functionality of the class of the same name in the <em>Analytics</em> microservice.</p>

<p><strong>3</strong> Dependency injection for an HTTP client that the Micronaut framework will implement at compile to make calls to <code>BookController</code>.</p>

<p><strong>4</strong> Use the <code>HttpClient</code> to retrieve the details of a <code>Book</code>, which will trigger sending a message.</p>

<p><strong>5</strong> Wait a few seconds for the message to arrive; it should happen very quickly, but the message will be sent on a separate thread.</p>

<p><strong>6</strong> Verify that the message was received and that it has the correct data.</p>

<p><strong>7</strong> Wait a few seconds to ensure no message is received.</p>
    
      <h4 id="115-analyticsclient">
        
        
          1.1.5. AnalyticsClient
        
        
      </h4>

<p>The GDK Launcher created a client interface to send messages to the streaming service in a file named <em>lib/src/main/java/com/example/publisher/AnalyticsClient.java</em> with the contents shown below. (Micronaut generates an implementation for the client interface at compilation time.)</p>

<pre><code class="language-java">package com.example.publisher;

import io.micronaut.configuration.kafka.annotation.KafkaClient;
import io.micronaut.configuration.kafka.annotation.Topic;
import reactor.core.publisher.Mono;

@KafkaClient
public interface AnalyticsClient {

    @Topic("analytics") // &lt;1&gt;
    Mono&lt;Book&gt; updateAnalytics(Book book); // &lt;2&gt;
}
</code></pre>

<p><strong>1</strong> Set the name of the topic. This matches the name of the topic used by <code>AnalyticsListener</code> in the <em>Analytics</em> microservice.</p>
<blockquote>
  <p>Note: This <strong>must</strong> match the name of the topic that you will create later.</p>
</blockquote>

<p><strong>2</strong> Send the <code>Book</code> POJO. Micronaut will automatically convert it to JSON before sending it.</p>
    
      <h4 id="116-analyticsfilter">
        
        
          1.1.6. AnalyticsFilter
        
        
      </h4>

<p>Sending a message to the streaming service is as simple as injecting <code>AnalyticsClient</code> and calling its <code>updateAnalytics</code> method.
The goal is to send a message every time the details of a book are returned from the <em>Books</em> microservice or, in other words, every time there is a call to <code>http://localhost:8080/books/{isbn}</code>.
To achieve this, the GDK Launcher created an <a href="https://docs.micronaut.io/latest/guide/#filters">Http Server Filter</a> in a file named <em>lib/src/main/java/com/example/publisher/AnalyticsFilter.java</em> as follows:</p>

<pre><code class="language-java">package com.example.publisher;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.MutableHttpResponse;
import io.micronaut.http.annotation.Filter;
import io.micronaut.http.filter.HttpServerFilter;
import io.micronaut.http.filter.ServerFilterChain;
import reactor.core.publisher.Flux;
import org.reactivestreams.Publisher;

@Filter("/books/?*") // &lt;1&gt;
class AnalyticsFilter implements HttpServerFilter { // &lt;2&gt;

    private final AnalyticsClient analyticsClient;

    AnalyticsFilter(AnalyticsClient analyticsClient) { // &lt;3&gt;
        this.analyticsClient = analyticsClient;
    }

    @Override
    public Publisher&lt;MutableHttpResponse&lt;?&gt;&gt; doFilter(HttpRequest&lt;?&gt; request,
                                                      ServerFilterChain chain) { // &lt;4&gt;
        return Flux
                .from(chain.proceed(request)) // &lt;5&gt;
                .flatMap(response -&gt; {
                    Book book = response.getBody(Book.class).orElse(null); // &lt;6&gt;
                    if (book == null) {
                        return Flux.just(response);
                    }
                    return Flux.from(analyticsClient.updateAnalytics(book)).map(b -&gt; response); // &lt;7&gt;
                });
    }
}
</code></pre>

<p><strong>1</strong> Annotate the class with <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Filter.html"><code>@Filter</code></a> and define the <a href="https://ant.apache.org/manual/dirtasks.html#patterns">Ant-style matcher pattern</a> to intercept all calls to the desired URIs.</p>

<p><strong>2</strong> The class must implement <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/filter/HttpServerFilter.html"><code>HttpServerFilter</code></a>.</p>

<p><strong>3</strong> Dependency injection for <code>AnalyticsClient</code>.</p>

<p><strong>4</strong> Implement the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/filter/HttpServerFilter.html#doFilter-io.micronaut.http.HttpRequest-io.micronaut.http.filter.FilterChain-"><code>doFilter</code></a> method.</p>

<p><strong>5</strong> Call the request; this will invoke the controller action.</p>

<p><strong>6</strong> Get the response from the controller and return the body as an instance of the <code>Book</code> class.</p>

<p><strong>7</strong> If the book is retrieved, use the client to send a message.</p>
    
      <h4 id="117-test-the-microservice">
        
        
          1.1.7. Test the Microservice
        
        
      </h4>

<p>Use the following command to test the <em>Books</em> microservice:</p>

<div id="tabs-doc3">
    <ul>
        <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
        <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
    </ul>
    <div id="gradle">
        <pre><code class="language-bash">./gradlew :gcp:test</code></pre>
    </div>
    <div id="maven">
        <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl gcp -DskipTests
./mvnw test</code></pre>
    </div>
</div>
    
      <h3 id="12-create-the-analytics-microservice">
        
        
          1.2. Create the <em>Analytics</em> Microservice <a href="#12-create-the-analytics-microservice" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Open the <a href="/gdk/launcher/?advanced=true">GDK Launcher in advanced mode</a>.</p>
  </li>
  <li>Create a new project using the following selections.
    <ul>
      <li><strong>Project Type</strong>: <em>Application</em> (Default)</li>
      <li><strong>Project Name</strong>: <em>analytics</em></li>
      <li><strong>Base Package</strong>: <em>com.example.consumer</em></li>
      <li><strong>Clouds</strong>: <em>GCP</em></li>
      <li><strong>Build Tool</strong>: <em>Gradle (Groovy)</em> or <em>Maven</em></li>
      <li><strong>Language</strong>: <em>Java</em> (Default)</li>
      <li><strong>Test Framework</strong>: <em>JUnit</em> (Default)</li>
      <li><strong>Java Version</strong>: <em>17</em> (Default)</li>
      <li><strong>Micronaut Version</strong>: (Default)</li>
      <li><strong>Cloud Services</strong>: <em>Streaming</em></li>
      <li><strong>Features</strong>: <em>Awaitility Framework</em>, <em>GraalVM Native Image</em> and <em>Micronaut Serialization Jackson Core</em></li>
      <li><strong>Sample Code</strong>: <em>No</em></li>
    </ul>
  </li>
  <li>Click <strong>Generate Project</strong>, then click <strong>Download Zip</strong>. The GDK Launcher creates an application with the default package <code>com.example.consumer</code> in a directory named <em>analytics</em>. The application ZIP file will be downloaded to your default downloads directory. Unzip it, open it in your code editor, and proceed to the next steps.</li>
</ol>

<p>Alternatively, use the <a href="/gdk/get-started/using-gdk-cli/">GDK CLI</a> as follows:</p>

<div id="tabs-doc2">
  <ul>
    <li class="tabs-gradle"><a href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <pre><code class="language-bash">gdk create-app com.example.consumer.analytics \
    --clouds=gcp \
    --services=streaming \
    --features=awaitility,graalvm,serialization-jackson \
    --build=gradle \
    --jdk=17 \
    --lang=java \
    --example-code=false</code></pre>
  </div>
  <div id="maven">
    <pre><code class="language-bash">gdk create-app com.example.consumer.analytics \
    --clouds=gcp \
    --services=streaming \
    --features=awaitility,graalvm,serialization-jackson \
    --build=maven \
    --jdk=17 \
    --lang=java \
    --example-code=false</code></pre>
  </div>
</div>
    
      <h4 id="121-domain-classes">
        
        
          1.2.1. Domain Classes
        
        
      </h4>

<p>The GDK Launcher created a <code>Book</code> domain class in a file named <em>lib/src/main/java/com/example/consumer/Book.java</em>, as shown below. (This <code>Book</code> POJO is the same as the one in the <em>Books</em> microservice. In a real application this would be in a shared library.)</p>

<pre><code class="language-java">package com.example.consumer;

import io.micronaut.core.annotation.Creator;
import io.micronaut.serde.annotation.Serdeable;

import java.util.Objects;

@Serdeable
public class Book {

    private final String isbn;
    private final String name;

    @Creator
    public Book(String isbn, String name) {
        this.isbn = isbn;
        this.name = name;
    }

    public String getIsbn() {
        return isbn;
    }

    public String getName() {
        return name;
    }

    @Override
    public String toString() {
        return "Book{" +
                "isbn='" + isbn + '\'' +
                ", name='" + name + '\'' +
                '}';
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Book other = (Book) o;
        return Objects.equals(isbn, other.isbn) &amp;&amp;
                Objects.equals(name, other.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(isbn, name);
    }
}
</code></pre>

<p>The GDK Launcher also created a <code>BookAnalytics</code> domain class in a file named <em>lib/src/main/java/com/example/consumer/BookAnalytics.java</em>, as follows:</p>

<pre><code class="language-java">package com.example.consumer;

import io.micronaut.core.annotation.Creator;
import io.micronaut.serde.annotation.Serdeable;

@Serdeable
public class BookAnalytics {

    private final String bookIsbn;
    private final long count;

    @Creator
    public BookAnalytics(String bookIsbn, long count) {
        this.bookIsbn = bookIsbn;
        this.count = count;
    }

    public String getBookIsbn() {
        return bookIsbn;
    }

    public long getCount() {
        return count;
    }
}
</code></pre>
    
      <h4 id="122-analyticsservice">
        
        
          1.2.2. AnalyticsService
        
        
      </h4>

<p>To keep this guide simple there is no database persistence: the <em>Analytics</em> microservice keeps book analytics in memory. The GDK Launcher created a class named <code>AnalyticsService</code> in <em>lib/src/main/java/com/example/consumer/AnalyticsService.java</em> with the following contents:</p>

<pre><code class="language-java">package com.example.consumer;

import jakarta.inject.Singleton;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

@Singleton
public class AnalyticsService {

    private final Map&lt;Book, Long&gt; bookAnalytics = new ConcurrentHashMap&lt;&gt;(); // &lt;1&gt;

    public void updateBookAnalytics(Book book) { // &lt;2&gt;
        bookAnalytics.compute(book, (k, v) -&gt; {
            return v == null ? 1L : v + 1;
        });
    }

    public List&lt;BookAnalytics&gt; listAnalytics() { // &lt;3&gt;
        return bookAnalytics
                .entrySet()
                .stream()
                .map(e -&gt; new BookAnalytics(e.getKey().getIsbn(), e.getValue()))
                .collect(Collectors.toList());
    }
}
</code></pre>

<p><strong>1</strong> Keep the book analytics in memory.</p>

<p><strong>2</strong> Initialize and update the analytics for the book passed as parameter.</p>

<p><strong>3</strong> Return all the analytics.</p>
    
      <h4 id="123-analyticsservicetest">
        
        
          1.2.3. AnalyticsServiceTest
        
        
      </h4>

<p>The GDK Launcher created a test for the <code>AnalyticsService</code> class, in a file named <em>gcp/src/test/java/com/example/consumer/AnalyticsServiceTest.java</em>, as follows:</p>

<pre><code class="language-java">package com.example.consumer;

import static org.junit.jupiter.api.Assertions.assertEquals;

import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import jakarta.inject.Inject;
import java.util.List;

@MicronautTest
class AnalyticsServiceTest {

    @Inject
    AnalyticsService analyticsService;

    @Test
    void testUpdateBookAnalyticsAndGetAnalytics() {
        Book b1 = new Book("1491950358", "Building Microservices");
        Book b2 = new Book("1680502395", "Release It!");

        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b2);

        List&lt;BookAnalytics&gt; analytics = analyticsService.listAnalytics();
        assertEquals(2, analytics.size());

        assertEquals(3, findBookAnalytics(b1, analytics).getCount());
        assertEquals(1, findBookAnalytics(b2, analytics).getCount());
    }

    private BookAnalytics findBookAnalytics(Book b, List&lt;BookAnalytics&gt; analytics) {
        return analytics
                .stream()
                .filter(bookAnalytics -&gt; bookAnalytics.getBookIsbn().equals(b.getIsbn()))
                .findFirst()
                .orElseThrow(() -&gt; new RuntimeException("Book not found"));
    }
}
</code></pre>
    
      <h4 id="124-analyticscontroller">
        
        
          1.2.4. AnalyticsController
        
        
      </h4>

<p>The GDK Launcher created a Controller to create an endpoint for the <em>Analytics</em> microservice in a file named <em>lib/src/main/java/com/example/consumer/AnalyticsController.java</em>, as follows:</p>

<pre><code class="language-java">package com.example.consumer;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;

import java.util.List;

@Controller("/analytics") // &lt;1&gt;
class AnalyticsController {

    private final AnalyticsService analyticsService;

    AnalyticsController(AnalyticsService analyticsService) {
        this.analyticsService = analyticsService;
    }

    @Get // &lt;2&gt;
    List&lt;BookAnalytics&gt; listAnalytics() {
        return analyticsService.listAnalytics();
    }
}
</code></pre>

<p><strong>1</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html"><code>@Controller</code></a> annotation defines the class as a controller mapped to the root URI <code>/analytics</code>.</p>

<p><strong>2</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>listAnalytics</code> method to an HTTP GET request on <code>/analytics</code>.</p>

<p>The application doesn’t expose the method <code>updateBookAnalytics</code> created in <code>AnalyticsService</code>. This method will be invoked when reading messages from Kafka.</p>
    
      <h4 id="125-analyticslistener">
        
        
          1.2.5. AnalyticsListener
        
        
      </h4>

<p>The GDK Launcher created a class to act as a consumer of the messages sent to the streaming service by the <em>Books</em> microservice. The Micronaut framework implements logic to invoke the consumer at compile time. The <code>AnalyticsListener</code> class is in a file named <em>lib/src/main/java/com/example/consumer/AnalyticsListener.java</em>, as follows:</p>

<pre><code class="language-java">package com.example.consumer;

import io.micronaut.configuration.kafka.annotation.KafkaListener;
import io.micronaut.configuration.kafka.annotation.Topic;
import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;

@Requires(notEnv = Environment.TEST) // &lt;1&gt;
@KafkaListener // &lt;2&gt;
class AnalyticsListener {

    private final AnalyticsService analyticsService; // &lt;3&gt;

    AnalyticsListener(AnalyticsService analyticsService) { // &lt;3&gt;
        this.analyticsService = analyticsService;
    }

    @Topic("analytics") // &lt;4&gt;
    void updateAnalytics(Book book) {
        analyticsService.updateBookAnalytics(book); // &lt;5&gt;
    }
}
</code></pre>

<p><strong>1</strong> Do not load this bean in the <code>test</code> environment: you can run tests without access to a streaming service.</p>

<p><strong>2</strong> Annotate the class with <code>@KafkaListener</code> to indicate that this bean consumes messages from Kafka.</p>

<p><strong>3</strong> Constructor injection for <code>AnalyticsService</code>.</p>

<p><strong>4</strong> Annotate the method with <code>@Topic</code> and specify the topic name. This matches the name of the topic used by <code>AnalyticsClient</code> in the <em>Books</em> microservice.</p>
<blockquote>
  <p>Note: This <strong>must</strong> match the name of the topic that you will create later.</p>
</blockquote>

<p><strong>5</strong> Call <code>AnalyticsService</code> to update the analytics for the book.</p>
    
      <h4 id="126-test-the-microservice">
        
        
          1.2.6. Test the Microservice
        
        
      </h4>

<p>Use the following command to test the <em>Analytics</em> microservice:</p>

<div id="tabs-doc4">
    <ul>
        <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
        <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
    </ul>
    <div id="gradle">
        <pre><code class="language-bash">./gradlew :gcp:test</code></pre>
    </div>
    <div id="maven">
        <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl gcp -DskipTests
./mvnw test</code></pre>
    </div>
</div>
    
      <h4 id="127-change-the-port-of-the-analytics-microservice">
        
        
          1.2.7. Change the Port of the <em>Analytics</em> Microservice
        
        
      </h4>

<p>The <em>Books</em> and <em>Analytics</em> microservices are both run on the same GCP Compute Engine instance, so they must run on different ports. Change the port that <em>Analytics</em> runs on by editing its <em>gcp/src/main/resources/application.properties</em> to include the following configuration:</p>

<pre><code>micronaut.server.port=8081
</code></pre>
    
      <h2 id="2-run-the-microservices">
        
        
          2. Run the Microservices <a href="#2-run-the-microservices" class="anchor_heading">#</a>
        
        
      </h2>
    
      <h3 id="21-start-the-books-microservice">
        
        
          2.1. Start the <em>Books</em> Microservice <a href="#21-start-the-books-microservice" class="anchor_heading">#</a>
        
        
      </h3>

<p>To run the <em>Books</em> microservice, use the following command, which starts the application on port 8080.</p>

<div id="tabs-doc5">
    <ul>
        <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
        <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
    </ul>
    <div id="gradle">
        <pre><code class="language-bash">./gradlew :gcp:run</code></pre>
    </div>
    <div id="maven">
        <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw -pl gcp mn:run</code></pre>
    </div>
</div>
    
      <h3 id="22-start-the-analytics-microservice">
        
        
          2.2. Start the <em>Analytics</em> Microservice <a href="#22-start-the-analytics-microservice" class="anchor_heading">#</a>
        
        
      </h3>

<p>To run the <em>Analytics</em> microservice, use the following command, which starts the application on port 8081.</p>

<div id="tabs-doc6">
    <ul>
        <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
        <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
    </ul>
    <div id="gradle">
        <pre><code class="language-bash">./gradlew :gcp:run</code></pre>
    </div>
    <div id="maven">
        <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw -pl gcp mn:run</code></pre>
    </div>
</div>
    
      <h3 id="23-test-the-microservices">
        
        
          2.3. Test the Microservices <a href="#23-test-the-microservices" class="anchor_heading">#</a>
        
        
      </h3>

<p>Use <code>curl</code> to test the microservices, as follows.</p>

<ol>
  <li>
    <p>Retrieve the list of books:</p>

    <pre><code class="language-bash"> curl http://localhost:8080/books
</code></pre>

    <pre><code class="language-json"> [{"isbn":"1491950358","name":"Building Microservices"},{"isbn":"1680502395","name":"Release It!"},{"isbn":"0321601912","name":"Continuous Delivery"}]
</code></pre>
  </li>
  <li>
    <p>Retrieve the details of a specified book:</p>

    <pre><code class="language-bash"> curl http://localhost:8080/books/1491950358
</code></pre>

    <pre><code class="language-json"> {"isbn":"1491950358","name":"Building Microservices"}
</code></pre>
  </li>
  <li>
    <p>Retrieve the analytics:</p>

    <pre><code class="language-bash"> curl http://localhost:8081/analytics
</code></pre>

    <pre><code class="language-json"> [{"bookIsbn":"1491950358","count":1}]
</code></pre>
  </li>
</ol>

<p>Update the <code>curl</code> command to the <em>Books</em> microservice to retrieve other books and repeat the invocations, then re-run the <code>curl</code> command to the <em>Analytics</em> microservice to see that the counts increase.</p>
    
      <h2 id="3-set-up-gcp-resources">
        
        
          3. Set up GCP Resources <a href="#3-set-up-gcp-resources" class="anchor_heading">#</a>
        
        
      </h2>

<p>Start with the Kafka cluster, and then configure the GCP Compute instance.</p>
    
      <h3 id="31-create-a-gcp-project">
        
        
          3.1. Create a GCP Project <a href="#31-create-a-gcp-project" class="anchor_heading">#</a>
        
        
      </h3>

<p>Create a new GCP project named “gdk-guides” (follow the instructions contained in <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects">Creating and managing projects</a>).</p>

<ol>
  <li>
    <p>Initialize the Cloud CLI:</p>

    <pre><code class="language-bash">gcloud init
</code></pre>
  </li>
  <li>
    <p>Log in to the Google Cloud Platform:</p>

    <pre><code class="language-bash">gcloud auth login
</code></pre>
  </li>
  <li>
    <p>Change your project:</p>

    <pre><code class="language-bash">gcloud config set project gdk-guides
</code></pre>
  </li>
</ol>
    
      <h3 id="32-configure-gcp-kafka-vm">
        
        
          3.2. Configure GCP Kafka VM <a href="#32-configure-gcp-kafka-vm" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>In the <a href="https://console.cloud.google.com/getting-started" target="_blank">Google Cloud console</a>, open the navigation menu, click <strong>Marketplace</strong>.</p>
  </li>
  <li>
    <p>In the search bar that appears, enter “Kafka”.</p>
  </li>
  <li>
    <p>Select <strong>Apache Kafka Server on CentOS 8 Server</strong> from the drop-down list of results.</p>
  </li>
  <li>
    <p>Click <strong>LAUNCH</strong>.</p>
  </li>
  <li>
    <p>Click <strong>ENABLE</strong> to enable required Google APIs, if necessary.</p>
  </li>
  <li>
    <p>Enter a deployment name: “streaming-kafka”.</p>
  </li>
  <li>
    <p>Select the <strong>us-east1-b</strong> zone.</p>
  </li>
  <li>
    <p>Deselect the check boxes for <strong>Allow TCP port 9092 traffic from the Internet</strong> and <strong>Allow TCP port 6667 traffic from the Internet</strong>.</p>
  </li>
  <li>
    <p>Click <strong>DEPLOY</strong> and wait for the deployment to finish.</p>
  </li>
  <li>
    <p>Copy the internal IP address of the Kafka service VM.
On your local computer run the following command:</p>

    <pre><code class="language-bash">gcloud compute instances list
</code></pre>

    <blockquote>
      <p>Note: Look for the <strong>INTERNAL_IP</strong> column (for example, <em>10.142.0.10</em>) and save it for later use.</p>
    </blockquote>
  </li>
</ol>
    
      <h3 id="33-launch-a-gcp-compute-instance">
        
        
          3.3. Launch a GCP Compute Instance <a href="#33-launch-a-gcp-compute-instance" class="anchor_heading">#</a>
        
        
      </h3>

<pre><code class="language-bash">gcloud compute instances create streaming-instance \
--image=centos-stream-9-v20230509 \
--image-project=centos-cloud \
--machine-type=n2-standard-4 \
--tags streaming-instance
</code></pre>

<blockquote>
  <p>Note: You will deploy the <em>Books</em> and <em>Analytics</em> microservices this compute instance.</p>
</blockquote>
    
      <h3 id="34-start-kafka-and-create-a-kafka-topic">
        
        
          3.4. Start Kafka and Create a Kafka Topic <a href="#34-start-kafka-and-create-a-kafka-topic" class="anchor_heading">#</a>
        
        
      </h3>

<blockquote>
  <p>Note: Open three terminals.</p>
</blockquote>

<ol>
  <li>
    <p>In the first terminal connect to the Kafka VM using SSH:</p>

    <pre><code class="language-bash"> gcloud compute ssh streaming-kafka-vm
</code></pre>
  </li>
  <li>
    <p>Run the following command to start the ZooKeeper service:</p>

    <pre><code class="language-bash"> cd /opt/kafka/
 sudo bin/zookeeper-server-start.sh config/zookeeper.properties
</code></pre>
  </li>
  <li>
    <p>In the second terminal, run the following command to start the Kafka broker service:</p>

    <pre><code class="language-bash"> cd /opt/kafka/
 sudo bin/kafka-server-start.sh config/server.properties
</code></pre>
  </li>
  <li>
    <p>In the third terminal, run the following command to create the <code>analytics</code> Kafka topic:</p>

    <pre><code class="language-bash"> cd /opt/kafka/
 sudo bin/kafka-topics.sh --create --topic analytics --bootstrap-server localhost:9092
</code></pre>
  </li>
</ol>
    
      <h2 id="4-generate-a-native-executable-using-graalvm">
        
        
          4. Generate a Native Executable Using GraalVM <a href="#4-generate-a-native-executable-using-graalvm" class="anchor_heading">#</a>
        
        
      </h2>

<p>The GDK supports compiling Java applications ahead-of-time into native executables using <a href="https://www.graalvm.org/" target="_blank">GraalVM Native Image</a>.
You can use the <em><a href="https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html" target="_blank">Gradle plugin for GraalVM Native Image building</a></em>/<em><a href="https://graalvm.github.io/native-build-tools/latest/maven-plugin.html" target="_blank">Maven plugin for GraalVM Native Image building</a></em>.
Packaged as a native executable, it significantly reduces application startup time and memory footprint.</p>

<blockquote>
  <p><strong>Prerequisites</strong>: Make sure you have installed a GraalVM JDK. The easiest way to get started is with <a href="https://sdkman.io/jdks#graal">SDKMAN!</a>. For other installation options, visit the <a href="https://www.graalvm.org/downloads/">Downloads section</a>.</p>
</blockquote>

<p>To generate a native executable, run the following command for each microservice:</p>

<div id="tabs-doc7">
  <ul>
    <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <pre><code class="language-bash">./gradlew :gcp:nativeCompile</code></pre>
    <p>The native executable is created in the <em>gcp/build/native/nativeCompile/</em> directory and can be run with the following command.</p>
    <pre><code class="language-bash">gcp/build/native/nativeCompile/gcp</code></pre>
  </div>
  <div id="maven">
    <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl gcp -Dpackaging=native-image</code></pre>
    <p>The native executable is created in the <em>gcp/target/</em> directory and can be run with the following command:</p>
    <pre><code class="language-bash">MICRONAUT_ENVIRONMENTS=dev gcp/target/gcp</code></pre>
    </div>
</div>

<p>Export the following environment variable; Micronaut will set the <code>kafka.bootstrap.servers</code> configuration property from its value:</p>

<pre><code class="language-bash">export KAFKA_BOOTSTRAP_SERVERS=&lt;replace_with_the_saved_internal_kafka_vm_address_&gt;:9092
</code></pre>

<p>Start the native executables for the two microservices and run the same <code>curl</code> requests as before to check that everything works as expected.</p>

<p>You can see that the microservices behave identically as if you run them from JAR files, but with reduced startup time and smaller memory footprint.</p>
    
      <h2 id="6-deploy-the-books-service-to-gcp-cloud">
        
        
          6. Deploy the <em>Books</em> service to GCP Cloud <a href="#6-deploy-the-books-service-to-gcp-cloud" class="anchor_heading">#</a>
        
        
      </h2>

<ol>
  <li>
    <p>Create a JAR file containing all the microservice’s dependencies, as follows:</p>

    <div id="tabs-doc8">
     <ul>
         <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">./gradlew :gcp:shadowJar</code></pre>
     </div>
     <div id="maven">
         <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl gcp -DskipTests</code></pre>
     </div>
 </div>
  </li>
  <li>
    <p>Copy the JAR file to your GCP Compute instance, as follows:</p>

    <div id="tabs-doc9">
     <ul>
         <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">gcloud compute scp gcp/build/libs/gcp-1.0-SNAPSHOT-all.jar streaming-instance:~/books_application.jar</code></pre>
     </div>
     <div id="maven">
         <pre><code class="language-bash">gcloud compute scp gcp/target/gcp-1.0-SNAPSHOT.jar streaming-instance:~/books_application.jar</code></pre>
     </div>
 </div>
  </li>
  <li>
    <p>Connect to the GCP Compute instance:</p>

    <pre><code class="language-bash"> gcloud compute ssh streaming-instance
</code></pre>
  </li>
  <li>
    <p>Once connected, install GraalVM JDK for Java 17. See <a href="https://www.graalvm.org/downloads/">Download Oracle GraalVM</a>.</p>
  </li>
  <li>
    <p>Start the <em>Books</em> microservice, as follows:</p>

    <pre><code class="language-bash"> java -jar books_application.jar
</code></pre>
  </li>
  <li>
    <p>Enable port 8080 via firewall rules:</p>

    <pre><code class="language-bash"> gcloud compute firewall-rules create firewall-rule-port-8080 --allow tcp:8080 --target-tags=streaming-instance
</code></pre>
  </li>
  <li>
    <p>Verify that the application is running by invoking the controller at <code>http://[GCP_PUBLIC_IP]:8080/books</code> using <code>curl</code>:</p>

    <pre><code class="language-bash"> curl -i http://[GCP_PUBLIC_IP]:8080/books
</code></pre>
  </li>
  <li>
    <p>Invoke the controller endpoint to trigger a message to be published to the Streaming service. You can test other ISBNs as well.</p>

    <pre><code class="language-bash"> curl -i http://[GCP_PUBLIC_IP]:8080/books/1491950358
</code></pre>
  </li>
</ol>
    
      <h2 id="7-deploy-the-analytics-microservice-to-gcp-cloud">
        
        
          7. Deploy the <em>Analytics</em> Microservice to GCP Cloud <a href="#7-deploy-the-analytics-microservice-to-gcp-cloud" class="anchor_heading">#</a>
        
        
      </h2>

<ol>
  <li>
    <p>Create a JAR file containing all the microservice’s dependencies, as follows:</p>

    <div id="tabs-doc10">
     <ul>
         <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">./gradlew :gcp:shadowJar</code></pre>
     </div>
     <div id="maven">
         <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl gcp -DskipTests</code></pre>
     </div>
 </div>
  </li>
  <li>
    <p>Copy the JAR file to your GCP Compute instance, as follows:</p>

    <div id="tabs-doc11">
     <ul>
         <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
         <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
     </ul>
     <div id="gradle">
         <pre><code class="language-bash">gcloud compute scp gcp/build/libs/gcp-1.0-SNAPSHOT-all.jar streaming-instance:~/analytics_application.jar</code></pre>
     </div>
     <div id="maven">
         <pre><code class="language-bash">gcloud compute scp gcp/target/gcp-1.0-SNAPSHOT.jar streaming-instance:~/analytics_application.jar</code></pre>
     </div>
 </div>
  </li>
  <li>
    <p>Connect to the GCP Compute instance:</p>

    <pre><code class="language-bash"> gcloud compute ssh streaming-instance
</code></pre>
  </li>
  <li>
    <p>Once connected, install GraalVM JDK with Native Image for Java 17. See <a href="https://www.graalvm.org/downloads/">Install GraalVM JDK with Native Image</a>.</p>
  </li>
  <li>
    <p>Start the <em>Analytics</em> microservice, as follows:</p>

    <pre><code class="language-bash"> java -jar analytics_application.jar
</code></pre>
  </li>
  <li>
    <p>Enable port 8081 via firewall rules:</p>

    <pre><code class="language-bash">gcloud compute firewall-rules create firewall-rule-port-8081 --allow tcp:8081 --target-tags=streaming-instance
</code></pre>
  </li>
  <li>
    <p>Verify that the application is running by invoking the controller at <code>http://[GCP_PUBLIC_IP]:8081/analytics</code> using <code>curl</code>:</p>

    <pre><code class="language-bash"> curl -i http://[GCP_PUBLIC_IP]:8081/analytics
</code></pre>
  </li>
</ol>
    
      <h2 id="8-deploy-native-executables-to-gcp">
        
        
          8. Deploy Native Executables to GCP <a href="#8-deploy-native-executables-to-gcp" class="anchor_heading">#</a>
        
        
      </h2>

<p>If you build a native executable locally, it will only run on your OS, and is not suitable for deployment to a GCP Compute instance.
To create a deployable native executable, use a different packaging command that builds the executable inside a container, which you will extract from the container to deploy to the cloud.</p>
    
      <h3 id="81-run-native-executables-on-the-gcp-instance">
        
        
          8.1. Run Native Executables on the GCP Instance <a href="#81-run-native-executables-on-the-gcp-instance" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Download the <a href="#prerequisites">example ZIP file</a> and copy it to the GCP instance:</p>

    <pre><code class="language-bash">gcloud compute scp /path/to/downloaded/streaming_sample.zip streaming-instance:~/streaming_sample.zip
</code></pre>
  </li>
  <li>
    <p>Once copied, connect to the GCP instance (if it has disconnected by now):</p>

    <pre><code class="language-bash"> gcloud compute ssh streaming-instance
</code></pre>
  </li>
  <li>
    <p>Unpack the compressed file:</p>

    <pre><code class="language-bash">sudo yum install unzip
unzip streaming_sample.zip
</code></pre>
  </li>
  <li>
    <p>Install the packages that GraalVM needs to work properly on GCP:</p>

    <pre><code class="language-bash">sudo yum -y install gcc
sudo yum -y install zlib*
</code></pre>
  </li>
  <li>
    <p>You must apply the settings from section <strong>5</strong> (Configure Microservices).</p>
  </li>
  <li>
    <p>To generate a native executable, run the following command for each microservice:</p>

    <div id="tabs-doc12">
   <ul>
     <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
     <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
   </ul>
   <div id="gradle">
     <pre><code class="language-bash">./gradlew :gcp:nativeCompile</code></pre>
     <p>The native executable is created in the <em>gcp/build/native/nativeCompile/</em> directory and can be run with the following command.</p>
     <pre><code class="language-bash">MICRONAUT_ENVIRONMENTS=gcp gcp/build/native/nativeCompile/gcp</code></pre>
     <p>Or if you use Windows:</p>
     <pre><code class="language-bash">cmd /C "set MICRONAUT_ENVIRONMENTS=gcp &amp;&amp; gcp\build\native\nativeCompile\gcp"</code></pre>
   </div>
   <div id="maven">
     <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl gcp -Dpackaging=native-image</code></pre>
     <p>The native executable is created in the <em>gcp/target/</em> directory and can be run with the following command:</p>
     <pre><code class="language-bash">MICRONAUT_ENVIRONMENTS=gcp gcp/target/gcp</code></pre>
     <p>Or if you use Windows:</p>
     <pre><code class="language-bash">cmd /C "set MICRONAUT_ENVIRONMENTS=gcp &amp;&amp; gcp\target\gcp"</code></pre>
   </div>
 </div>

    <p>Start the native executables for the two microservices and run the same <code>curl</code> requests as before to check that everything works as expected.</p>
  </li>
</ol>

<p>You can see that the microservices behave identically as if you run them from JAR files, but with reduced startup time and smaller memory footprint.</p>
    
      <h2 id="9-clean-up">
        
        
          9. Clean Up <a href="#9-clean-up" class="anchor_heading">#</a>
        
        
      </h2>

<p>When you have completed the guide, you can clean up the resources you created on Google Cloud Platform so you will not be billed for them in the future.</p>
    
      <h3 id="91-delete-the-project">
        
        
          9.1. Delete the Project <a href="#91-delete-the-project" class="anchor_heading">#</a>
        
        
      </h3>

<p>The easiest way to eliminate billing is to delete the project you created.</p>

<p>Deleting a project has the following consequences:</p>

<ul>
  <li>
    <p>If you used an existing project, you will also delete any other work you have done in the project.</p>
  </li>
  <li>
    <p>You cannot reuse the project ID of a deleted project. If you created a custom project ID that you plan to use in the future, you should delete the resources inside the project instead. This ensures that URLs that use the project ID, such as an <em>appspot.com</em> URL, remain available.</p>
  </li>
  <li>
    <p>If you are exploring multiple guides, reusing projects instead of deleting them prevents you from exceeding project quota limits.</p>
  </li>
</ul>
    
      <h4 id="911-via-the-cli">
        
        
          9.1.1. Via the CLI
        
        
      </h4>
<p>To delete the project using the Google Cloud CLI, run the following command:</p>

<pre><code class="language-bash">gcloud projects delete gdk-guides
</code></pre>
    
      <h4 id="912-via-the-cloud-platform-console">
        
        
          9.1.2. Via the Cloud Platform Console
        
        
      </h4>

<ol>
  <li>
    <p>In the Cloud Platform Console, go to the <a href="https://console.cloud.google.com/iam-admin/projects">Projects page</a>.</p>
  </li>
  <li>
    <p>In the project list, select the project you want to delete and click <strong>Delete project</strong>. Select the check box next to the project name and click <strong>Delete project</strong>.</p>
  </li>
  <li>
    <p>In the dialog box, enter the project ID, and then click <strong>Shut down</strong> to delete the project.</p>
  </li>
</ol>
    
      <h3 id="summary">
        
        
          Summary <a href="#summary" class="anchor_heading">#</a>
        
        
      </h3>

<p>In this guide you created a streaming application with the Micronaut framework, Kafka, and Google Cloud Platform Apache Kafka VM. The communication between two microservices acting as a producer and consumer ran asynchronously. Then you packaged these microservices into native executables with GraalVM Native Image for their faster startup and reduced memory footprint, and deployed to Google Cloud Platform.</p>
    
      <h3 id="related-documentation">
        
        
          Related Documentation <a href="#related-documentation" class="anchor_heading">#</a>
        
        
      </h3>

<ul>
  <li><a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Kafka support in Micronaut</a></li>
  <li><a href="https://micronaut-projects.github.io/micronaut-gcp/latest/guide/index.html">Micronaut Google Cloud Support</a></li>
  <li><a href="https://luna.oracle.com/lab/47dafec8-4095-4fba-8313-dad43a64dee4">GraalVM Native Image Quick Start</a></li>
</ul>

      </div>

      <div role="button" class="menu-btn menu-btn--sidebar js-show-sidebar" title="sweet hamburger">
        <div class="hamburger">
          <div class="inner"></div>
        </div>
      </div>
    </div>
  </div>
</article>



</div>

      </main>

      
<footer class="footer footer__mobile">

  <div class="container-fluid container-fluid--custom-sm">
    <div class="row">
      <div class="col-12 col-sm-12 col-md-12 col-lg-12">
        <div class="row footer-content">
          <div class="col-md-3 col-sm-4">
            <h6 class="title-footer" onclick="fadeInAndOut(this)">Learn</h6>
            <div class="grow">
              <ul class="footer-list">
                <li class="footer-list__item"><a href="/gdk/get-started/">Get Started</a></li>
                <li class="footer-list__item"><a href="/gdk/guides/">Guides</a></li>
                <li class="footer-list__item"><a href="/gdk/hands-on-labs/">Labs</a></li>
                <li class="footer-list__github">
                  <img class="footer__icon" src="/gdk/resources/img/footer/logo-github.svg" alt="Github icon">
                  <a href="https://github.com/oracle/graal-dev-kit" target="blank">Github</a>
                </li>
                <li class="footer-list__github">
                  <img class="footer__icon" src="/gdk/resources/img/footer/slack-icon.svg" alt="Github icon">
                  <a href="https://bit.ly/odevrel_slack" target="blank">#graal-dev-kit-for-micronaut</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-md-3 col-sm-4">
            <h6 class="title-footer" onclick="fadeInAndOut(this)">About</h6>
            <div class="grow">
              <ul class="footer-list">
                <li class="footer-list__item"><a href="/gdk/about/#gdk-support" target="blank">Commercial Support</a></li>
                <li class="footer-list__item"><a href="https://www.graalvm.org/" target="blank">GraalVM Native Image</a></li>
                <li class="footer-list__item"><a href="https://micronaut.io/" target="_blank">Micronaut<sup>&reg;</sup> Framework</a></li>
                <li class="footer-list__item"><a href="https://www.oracle.com/cloud/multicloud/what-is-multicloud/" target="_blank">Multicloud</a></li>
                <li class="footer-list__item"><a href="https://www.oracle.com/cloud/" target="blank">Oracle Cloud Infrastructure</a></li>
                <li class="footer-list__item"><a href="https://marketplace.visualstudio.com/items?itemName=oracle-labs-graalvm.graal-cloud-native-pack" target="blank">VS Code Tools</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md-6 col-sm-12 aligning_1024">
            <div class="card--footer card--hovered box">
              <div>
                <div class="rubber-footer footer__oci-section">
                  <p class="title-footer quickstart">Build, test, and deploy applications on Oracle Cloud Infrastructure for free</p>
                  <a href="https://www.oracle.com/cloud/free/" target="_blank"
                    class="btn btn-primary">Try Oracle Cloud Infrastructure Free Tier</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
          <div class="row">
            <div class="col-sm-12">
              <p class="copyright">
                Copyright &copy; 2023-2024, Oracle and/or its affiliates.
                All rights reserved.
                Oracle and Java are registered trademarks of Oracle and/or its affiliates.<br/>
                Micronaut<sup>&reg;</sup> is a registered trademark of Object Computing, Inc.
                Use is for referential purposes and does not imply any endorsement or affiliation with any third-party product.
                Unauthorized use is strictly prohibited. Other names may be trademarks of their respective owners.
              </p>
              <div id="teconsent"></div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</footer>

<script>
  function fadeInAndOut(thz) {
    var elmt = thz.nextElementSibling;//Get the element that is below the button that
    //was just clicked
    if (elmt.clientHeight) {
      elmt.style.height = 0;
    } else {
      var wrapper = elmt.querySelector('ul');
      elmt.style.height = wrapper.clientHeight + "px";
    }
    /*
        elmt.classList.toggle("acordianPanelHidden");//Toggle the class which changes
        //attributes which triggers the transition CSS
        */
  }

  // Check TRUSTe Consent for Functional or Implied Approval
  // The if test verifies if the user has given the consent
  if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
      (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
        oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(2) != -1) ) {

      //The following is a sample of a Maxymiser Tag being written to the DOM
      //If the user did not give consent, then the tag is not included and not invoked in the Browser
      document.write('<script type="text/javascript" src="//service.maxymiser.net/cdn/oracle/js/mmcore.js"><\/script>');
  }

  // Check TRUSTe Consent for Advertising or Implied Approval
  // The if test verifies if the user has given the consent
  if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
      (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
        oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(3) != -1) ) {

      //The following is a sample of a BlueKai Core Tag being written to the DOM
      //If the user did not give consent, then the tag is not included and not invoked in the Browser
      document.write('<script type="text/javascript">' +
      'window.bk_async = function() { ' +
      'BKTAG.doTag(62581, 1); }; ' +
      '(function() { ' +
      'var scripts = document.getElementsByTagName(\'script\')[0]; ' +
      'var s = document.createElement(\'script\'); ' +
      's.async = true; ' +
      's.src = "https://tags.bkrtx.com/js/bk-coretag.js"; ' +
      'scripts.parentNode.insertBefore(s, scripts); ' +
      '}()); ' +
      '<\/script>');
  }
</script>

    </div>
    <div class="overlay"></div>

    <!-- Start SiteCatalyst code -->
    <script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script>
    <!-- End SiteCatalyst code -->

    <script src='/gdk/resources/lib/slick-slider/slick.min.js'></script>
    <script src='/gdk/resources/js/main.js'></script>
    <script src='/gdk/resources/js/ui.js'></script>
    <script src='/gdk/resources/js/filters.js'></script>
    <script src='/gdk/resources/js/sidebar.js'></script>
    <script src='/gdk/resources/js/labs.js'></script>
    <script src='/gdk/resources/lib/highlight/highlight.min.js'></script>
    <script>hljs.highlightAll();</script>
  </body>
</html>
