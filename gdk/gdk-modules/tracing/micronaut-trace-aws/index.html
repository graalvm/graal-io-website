<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="/gdk/resources/img/graalvm.png" />
  <meta name="twitter:widgets:border-color" content="#55acee">

  <title>
    
      Create and Trace a Micronaut Application Using AWS X-Ray
    
  </title>
  <meta name="description" content="The Graal Development Kit for Micronaut (GDK) is a build of a curated set of Micronaut framework modules and their required libraries for building portable c..."/>
  <meta name="last_modified" content="2024-10-02 07:38:27 +0000"/>
  <meta name="last_built" content="2024-10-22 11:25:28 +0000"/>
  <link rel="stylesheet" href="/gdk/assets/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/gdk/resources/img/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/gdk/resources/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/gdk/resources/img/favicon/favicon-16x16.png">
  <link rel="manifest" href="/gdk/resources/img/favicon/site.webmanifest">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <meta name="google-site-verification" content="-vRqwa9WYn6AaQGnl88xvrLw6ac4xoKVkZkhanmlRhU" />
  <link rel="canonical" href="https://www.graal.cloud/gdk/gdk-modules/tracing/micronaut-trace-aws/">

  <!-- jQuery UI Tabs -->
  <link rel="stylesheet" href="//code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/gdk/resources/lib/jquery/jquery-ui.css">
</head>

      <script src="/gdk/resources/lib/jquery/jquery-3.7.1.min.js"></script>
    <script src="/gdk/resources/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src='/gdk/resources/lib/sticky-sidebar/resizeSensor.js'></script>
    <script src='/gdk/resources/lib/sticky-sidebar/sticky-sidebar.min.js'></script>
    <script src="/gdk/resources/lib/highlight/highlight.min.js"></script>
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Add TRUSTe Consent Script and Analytics -->
    <script async="async" type="text/javascript" src='//consent.trustarc.com/notice?domain=oracle.com&c=teconsent&js=bb&noticeType=bb&text=true&cdn=1&pcookie&gtm=1' crossorigin></script>
    <script src="https://www.oracle.com/assets/truste-oraclelib.js"></script>
    <!-- jQuery UI Tabs -->
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>


  <body class="preload">
    <!-- Start SiteCatalyst code -->
    <script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script>
    <!-- End SiteCatalyst code -->

    <div  class="wrapper wrapper--nofooter" >

      <header  class="header header--content" 
  role="banner">

  

  

    <nav class="menu">
      <div class="menu__row">
        <div>
          <a href="/gdk/">
            <img class="logo-mobile" src="/gdk/resources/img/gdk-logo-new.svg" alt="Graal Development Kit for Micronaut logo">
          </a>
        </div>
        <div class="menu__container">
          <ul class="menu__list">
            <li class="menu__item">
              <a href="/gdk/about/" class="menu__link">About</a>
            </li>
            <li class="menu__item">
              <a href="/gdk/get-started/" class="menu__link">Get Started</a>
            </li>
            <li class="menu__item">
              <div class="stack-container">
                <a href="#" class="menu__link stack__header">Docs</a>
                <div class="stack-menu-learn">
                  <div class="stack-row">
                    <div class="stack-column">
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/modules.svg'>
                        <a href="/gdk/modules/" class="item-line">Modules</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/guides.svg'>
                        <a href="/gdk/guides/" class="item-line">Guides</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/labs.svg'>
                        <a href="/gdk/hands-on-labs/" class="item-line">Hands-On Labs</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/tools.svg'>
                        <a href="/gdk/vscode-tools/" class="item-line">Tools</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <li class="menu__item">
              <div class="stack-container">
                <a href="#" class="menu__link stack__header">Graal Projects</a>
                <div class="stack-menu">
                  <div class="stack-row">
                    <div class="stack-column">
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalstack.svg'>
                        <a href="https://graal.cloud/" class="item-line">Graal</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalvm.svg'>
                        <a href="https://graalvm.org/" class="item-line">GraalVM</a>
                      </div>
                      <div class="stack__item">
                        <img src='/gdk/resources/img/header-navigation/graalos.svg'>
                        <a href="https://graal.cloud/graalos/" class="item-line">GraalOS</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <li class="menu__launch__mobile">
              <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
            </li>
          </ul>
        </div>
        <div class="menu__launch">
          <a href="/gdk/launcher/" class="btn-launch btn btn-primary" target="blank">Create App</a>
        </div>
      </div>

      <div role="button" class="menu-btn menu-btn--menu js-show-menu" tabindex="-1" title="sweet hamburger">
        <div class="hamburger">
          <div class="inner"></div>
        </div>
      </div>
      <button aria-label="hamburger mobile menu" class="btn btn-mobile-menu js-show-menu">
        <div class="inner"></div>
      </button>
    </nav>

  
</header>


      <main  class="content"   aria-label="Content">
        <div class="wrapper wrapper-content">
  <article>
  <div class="row d-flex flex-wrap">
    <div class="col-sm-3 docsimpro col-bg">
      <div class="sidebar-wrap">
        <div class="sidebar">
          <div class="menuabout">
            <img id="sidebarClose" src="/gdk/resources/img/arrow_sidebar(close).svg" alt="Expand or collapse sidebar"
              class="btn-color no-display">
            <img id="sidebarOpen" src="/gdk/resources/img/arrow_sidebar.svg" alt="Expand or collapse sidebar">
          </div>
          
<div class="toc-floating">


<div class="toc-bullets">


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    

    
      
        
          <li class="toc-bullets-main">
        
          
          <a href="/gdk/docs/gdk-modules/tracing/" class="_icon-book">
            Tracing
          </a>
        </li>

        
        

        
        
          
          <li class="toc-bullets-sub toc-bullets-highlight">
          
            
            <a href="/gdk/gdk-modules/tracing/micronaut-trace-aws/">
              Create and Trace a Micronaut Application Using AWS X-Ray
            </a>
          </li>

          
            <div>
  <script>
    var scriptElement = document.currentScript;
    var div = $(scriptElement.parentElement);
    $(window).on("load", function () {
      $("#content-wrapper h2").each(function () {
        var li = $("<li></li>", { class: "toc-bullets-sub toc-bullets-sub-3" });
        var a = $("<a></a>", { href: "#" + $(this).attr("id") });
        a.text($(this).text().replace('#', ''));
        li.append(a);
        li.click(function (e) {
          e.preventDefault();
          var target = $(a.attr('href'));
          var scrollTo = target.offset().top - 80; // 80 - indent
          $('html, body').animate({ scrollTop: scrollTo }, 1000);
        });
        div.append(li);
      });
    });
  </script>
</div>
          
        
      
    
  

  

  

  

  

  

  

  

  

<!-- <li class="search additional-search">
  <form class="form-inline sidebar" action="/docs/search" autocomplete="on" method="get">
    <input class="input-search sidebar" type="text" id="search-box" name="query" placeholder="Search">
    <button type="submit sidebar" class="search-button"></button>
  </form>
</li> -->

</div>
  <!-- Search form -->
  <!-- <form class="search-container" action="/docs/search" autocomplete="on" method="get">
   <label for="search-box">Search</label>
    <input type="text" id="search-box" name="query">
    <button type="submit" class="searchbttn"></button>
  </form> -->
</div>

        </div>
      </div>
    </div>

    <div class="col-sm-9 docsmod">
      <div id="content-wrapper" class="docs-content docs-content--with-sidebar">
        <!--
          Include file to warn of Windows/Gradle restriction
        -->
        <h1 id="create-and-trace-a-micronaut-application-using-aws-x-ray">
        
        
          Create and Trace a Micronaut Application Using AWS X-Ray
        
        
      </h1>

<p>This guide describes how to use the Graal Development Kit for Micronaut (GDK) to create and trace a Micronaut<sup>®</sup> application using <a href="https://aws.amazon.com/xray/">AWS X-Ray</a>.</p>

<blockquote>
  <p><a href="https://aws.amazon.com/xray/">AWS X-Ray</a> is a service to monitor application traces, including the performance of calls to downstream components or services, in either cloud-hosted applications or locally deployments.</p>
</blockquote>

<p>Tracing enables you to track service requests in a single or distributed application. Trace data shows the path, time spent in each section (called a <em>span</em>), and other information collected along during the trace.
Tracing gives you observability into what is causing bottlenecks and failures.</p>
    
      <h3 id="prerequisites">
        
        
          Prerequisites <a href="#prerequisites" class="anchor_heading">#</a>
        
        
      </h3>

<ul>
  <li>JDK 17 or higher. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>.</li>
  <li>An Amazon Web Services (AWS) account. See <a href="/gdk/get-started/setting-up-cloud-accounts/">Setting up Your Cloud Accounts</a>.</li>
  <li>The <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI</a>.</li>
  <li>A Docker-API compatible container runtime such as <a href="https://docs.rancherdesktop.io/getting-started/installation/">Rancher Desktop</a> or <a href="https://www.docker.io/gettingstarted/">Docker</a>.</li>
  <li>The GDK CLI. See <a href="/gdk/get-started/setting-up-desktop/">Setting up Your Desktop</a>. (Optional.)</li>
</ul>

<p>Follow the steps below to create the application from scratch. However, you can also download the completed example:</p>

<div id="tabs-doc1">
  <ul>
    <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <p><a href="https://github.com/oracle/graal-dev-kit/releases/download/4.6.0.3/4.6.0.3_tracing_aws-tracing-demo-java-gradle.zip">Gradle AWS Tracing Example <img class="download-img-guides" src="/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" /></a>
    </p>
  </div>
  <div id="maven">
    <p><a href="https://github.com/oracle/graal-dev-kit/releases/download/4.6.0.3/4.6.0.3_tracing_aws-tracing-demo-java-maven.zip">Maven AWS Tracing Example <img class="download-img-guides" src="/gdk/resources/img/gdk_modules/download-archive.png" alt="Download completed example" /></a>
    </p>
  </div>
</div>
    
      <h4 id="a-note-regarding-your-development-environment">
        
        
          A note regarding your development environment
        
        
      </h4>

<p>Consider using Visual Studio Code, which provides native support for developing applications with the <a href="/gdk/vscode-tools/using-gdk-vscode-tools/">Graal Development Kit extension</a>.</p>

<blockquote>
  <p>Note: If you use IntelliJ IDEA, <a href="/gdk/resources/img/annotationprocessorsintellij.png">enable annotation processing</a>.</p>
</blockquote>

<blockquote>
  <p>Windows platform: The GDK guides are compatible with Gradle only. Maven support is coming soon.</p>
</blockquote>
    
      <h2 id="1-create-the-application">
        
        
          1. Create the Application <a href="#1-create-the-application" class="anchor_heading">#</a>
        
        
      </h2>

<p>Create an application using the GDK Launcher.</p>

<ol>
  <li>
    <p>Open the <a href="/gdk/launcher/?advanced=true">GDK Launcher in advanced mode</a>.</p>
  </li>
  <li>Create a new project using the following selections.
    <ul>
      <li><strong>Project Type</strong>: <em>Application</em> (default)</li>
      <li><strong>Project Name</strong>: <em>aws-tracing-demo</em></li>
      <li><strong>Base Package</strong>: <em>com.example</em> (Default)</li>
      <li><strong>Clouds</strong>: <em>AWS</em></li>
      <li><strong>Build Tool</strong>: <em>Gradle (Groovy)</em> or <em>Maven</em></li>
      <li><strong>Language</strong>: <em>Java</em> (Default)</li>
      <li><strong>Test Framework</strong>: <em>JUnit</em> (default)</li>
      <li><strong>Java Version</strong>: <em>17</em> (default)</li>
      <li><strong>Micronaut Version</strong>: (default)</li>
      <li><strong>Cloud Services</strong>: <em>Tracing</em></li>
      <li><strong>Features</strong>: <em>GraalVM Native Image</em> (Default)</li>
      <li><strong>Sample Code</strong>: <em>No</em></li>
    </ul>
  </li>
  <li>Click <strong>Generate Project</strong>, then click <strong>Download Zip</strong>. The GDK Launcher creates an application with the default package <code>com.example</code> in a directory named <em>aws-tracing-demo</em>. The application ZIP file will be downloaded to your default downloads directory. Unzip it, open it in your code editor, and proceed to the next steps.</li>
</ol>

<p>Alternatively, use the GDK CLI as follows:</p>

<div id="tabs-doc2">
    <ul>
        <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
        <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
    </ul>
    <div id="gradle">
        <pre><code class="language-bash">gdk create-app com.example.aws-tracing-demo \
    --clouds=aws \
    --services=tracing \
    --features=graalvm \
    --example-code=false \
    --build=gradle \
    --jdk=17 \
    --lang=java</code></pre>
    </div>
    <div id="maven">
        <pre><code class="language-bash">gdk create-app com.example.aws-tracing-demo \
    --clouds=aws \
    --services=tracing \
    --features=graalvm \
    --example-code=false \
    --build=maven \
    --jdk=17 \
    --lang=java</code></pre>
    </div>
</div>

<p>For more information, see <a href="/gdk/get-started/using-gdk-cli/">Using the GDK CLI</a>.</p>
    
      <h3 id="11-tracing-annotations">
        
        
          1.1. Tracing Annotations <a href="#11-tracing-annotations" class="anchor_heading">#</a>
        
        
      </h3>

<p>The Micronaut framework uses the <a href="https://micronaut-projects.github.io/micronaut-tracing/latest/api/io/micronaut/tracing/annotation/package-summary.html"><code>io.micronaut.tracing.annotation</code></a> package and <a href="https://opentelemetry.io/">OpenTelemetry</a> to generate and export tracing data.</p>

<p>The <code>io.micronaut.tracing.annotation</code> package provides the following three annotations:</p>

<ul>
  <li>
    <p><a href="https://micronaut-projects.github.io/micronaut-tracing/latest/api/io/micronaut/tracing/annotation/NewSpan.html"><code>@NewSpan</code></a>: Used on methods to create a new span; defaults to the <em>method</em> name, but you can assign a unique name instead.</p>
  </li>
  <li>
    <p><a href="https://micronaut-projects.github.io/micronaut-tracing/latest/api/io/micronaut/tracing/annotation/ContinueSpan.html"><code>@ContinueSpan</code></a>: Used on methods to continue an existing span; primarily used in conjunction with <code>@SpanTag</code> (below).</p>
  </li>
  <li>
    <p><a href="https://micronaut-projects.github.io/micronaut-tracing/latest/api/io/micronaut/tracing/annotation/SpanTag.html"><code>@SpanTag</code></a>: Used on method parameters to assign a value to a span; defaults to the <em>parameter</em> name, but you can assign a unique name instead. To use the <code>@SpanTag</code> on a method parameter, the method must be annotated with either <code>@NewSpan</code> or <code>@ContinueSpan</code>.</p>
  </li>
</ul>

<p>Your build configuration file contains the <code>io.micronaut.tracing</code> dependency which means all HTTP server methods (those annotated with <code>@Get</code>, <code>@Post</code>, and so on) create spans automatically.</p>
    
      <h3 id="12-inventoryservice">
        
        
          1.2. InventoryService <a href="#12-inventoryservice" class="anchor_heading">#</a>
        
        
      </h3>

<blockquote>
  <p>Note: The <code>InventoryService</code> class demonstrates how to create and use spans from <code>io.micronaut.tracing.annotation</code> and OpenTelemetry.</p>
</blockquote>

<p>The GDK Launcher created the <code>InventoryService</code> class in a file named <em>lib/src/main/java/com/example/InventoryService.java</em>, as follows:</p>

<pre><code class="language-java">package com.example;

import io.micronaut.tracing.annotation.NewSpan;
import io.micronaut.tracing.annotation.SpanTag;
import io.opentelemetry.api.trace.Span;
import io.opentelemetry.api.trace.Tracer;
import jakarta.inject.Singleton;

import java.util.Collection;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Singleton
public class InventoryService {

    private static final String storeName = "my_store";

    private final Tracer tracer;
    private final WarehouseClient warehouse;
    private final Map&lt;String, Integer&gt; inventory = new ConcurrentHashMap&lt;&gt;();

    InventoryService(Tracer tracer, WarehouseClient warehouse) { // &lt;1&gt;
        this.tracer = tracer;
        this.warehouse = warehouse;

        inventory.put("laptop", 4);
        inventory.put("desktop", 2);
        inventory.put("monitor", 11);
    }

    public Collection&lt;String&gt; getProductNames() {
        return inventory.keySet();
    }

    @NewSpan("stock-counts") // &lt;2&gt;
    public Map&lt;String, Integer&gt; getStockCounts(@SpanTag("inventory.item") String item) { // &lt;3&gt;
        Map&lt;String, Integer&gt; counts = new HashMap&lt;&gt;();
        if (inventory.containsKey(item)) {
            int count = inventory.get(item);
            counts.put("store", count);

            if (count &lt; 10) {
                counts.put("warehouse", inWarehouse(storeName, item));
            }
        }

        return counts;
    }

    private int inWarehouse(String store, String item) {
        Span.current().setAttribute("inventory.store-name", store); // &lt;4&gt;

        return warehouse.getItemCount(store, getUPC(item));
    }

    public void order(String item, int count) {
        orderFromWarehouse(item, count);
        if (inventory.containsKey(item)) {
            count += inventory.get(item);
        }
        inventory.put(item, count);
    }

    private void orderFromWarehouse(String item, int count) {
        Span span = tracer.spanBuilder("warehouse-order") // &lt;5&gt;
                .setAttribute("item", item)
                .setAttribute("count", count)
                .startSpan();

        warehouse.order(Map.of(
                "store", storeName,
                "product", item,
                "amount", count,
                "upc", getUPC(item)));

        span.end(); // &lt;6&gt;
    }

    private int getUPC(String item) {
        return Math.abs(item.hashCode());
    }
}
</code></pre>
<p><strong>1</strong> Inject an OpenTelemetry Tracing bean into the class.</p>

<p><strong>2</strong> Create a new <code>io.micronaut.tracing.annotation</code> span called “stock-counts”.</p>

<p><strong>3</strong> Add a <code>io.micronaut.tracing.annotation</code> tag called “inventory.item” that will contain the value contained in the parameter <code>item</code>.</p>

<p><strong>4</strong> Get the current OpenTelemetry span and set the value of its attribute named “inventory.store-name” to the <code>store</code> parameter.</p>

<p><strong>5</strong> Create an OpenTelemetry span named “warehouse-order”, set its attributes and start the span.</p>

<p><strong>6</strong> End the span started in <strong>5</strong>.</p>
    
      <h3 id="13-store-controller">
        
        
          1.3. Store Controller <a href="#13-store-controller" class="anchor_heading">#</a>
        
        
      </h3>

<p>The GDK Launcher created the <code>StoreController</code> class in a file named <em>lib/src/main/java/com/example/StoreController.java</em>, as follows:</p>

<pre><code class="language-java">package com.example;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Post;
import io.micronaut.http.annotation.Status;
import io.micronaut.scheduling.TaskExecutors;
import io.micronaut.scheduling.annotation.ExecuteOn;
import io.micronaut.tracing.annotation.ContinueSpan;
import io.micronaut.tracing.annotation.NewSpan;
import io.micronaut.tracing.annotation.SpanTag;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import static io.micronaut.http.HttpStatus.CREATED;

@ExecuteOn(TaskExecutors.IO)
@Controller("/store")
class StoreController {

    private final InventoryService inventory;

    StoreController(InventoryService inventory) {
        this.inventory = inventory;
    }

    @Post("/order")
    @Status(CREATED)
    @NewSpan("store.order") // &lt;1&gt;
    void order(@SpanTag("order.item") String item, @SpanTag int count) { // &lt;2&gt;
        inventory.order(item, count);
    }

    @Get("/inventory") // &lt;3&gt;
    List&lt;Map&lt;String, Object&gt;&gt; getInventory() {
        return inventory.getProductNames().stream()
                .map(this::getInventory)
                .collect(Collectors.toList());
    }

    @Get("/inventory/{item}")
    @ContinueSpan // &lt;4&gt;
    Map&lt;String, Object&gt; getInventory(@SpanTag("item") String item) { // &lt;5&gt;
        Map&lt;String, Object&gt; counts = new HashMap&lt;&gt;(inventory.getStockCounts(item));
        if (counts.isEmpty()) {
            counts.put("note", "Not available at store");
        }

        counts.put("item", item);

        return counts;
    }
}
</code></pre>

<p><strong>1</strong> Create a new span called “store.order”.</p>

<p><strong>2</strong> Add tags for the method parameters. Name the first parameter “order.item”, and use the default name for the second parameter.</p>

<p><strong>3</strong> A span is created automatically if your build configuration file contains the <code>io.micronaut.tracing</code> dependency.</p>

<p><strong>4</strong> Required for <code>@SpanTag</code> (see <strong>5</strong>).</p>

<p><strong>5</strong> Add a tag for the method parameter.</p>
    
      <h3 id="14-warehouse-client">
        
        
          1.4. Warehouse Client <a href="#14-warehouse-client" class="anchor_heading">#</a>
        
        
      </h3>

<p>The GDK Launcher created the <code>WarehouseClient</code> class in a file named <em>lib/src/main/java/com/example/WarehouseClient.java</em>, as follows:</p>

<pre><code class="language-java">package com.example;

import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Post;
import io.micronaut.http.annotation.QueryValue;
import io.micronaut.http.client.annotation.Client;
import io.micronaut.tracing.annotation.ContinueSpan;
import io.micronaut.tracing.annotation.NewSpan;
import io.micronaut.tracing.annotation.SpanTag;

import java.util.Map;

@Client("/warehouse") // &lt;1&gt;
public interface WarehouseClient {

    @Post("/order")
    @NewSpan
    void order(@SpanTag("warehouse.order") Map&lt;String, ?&gt; json);

    @Get("/count")
    @ContinueSpan
    int getItemCount(@QueryValue String store,
                     @SpanTag @QueryValue int upc);
}
</code></pre>

<p><strong>1</strong> Some external service without tracing.</p>
    
      <h3 id="15-warehouse-controller">
        
        
          1.5. Warehouse Controller <a href="#15-warehouse-controller" class="anchor_heading">#</a>
        
        
      </h3>

<p>The GDK Launcher created a <code>WarehouseController</code> class to represent an external service that will be called by <code>WarehouseClient</code> in a file named <em>lib/src/main/java/com/example/WarehouseController.java</em>, as follows:</p>

<pre><code class="language-java">package com.example;

import io.micronaut.http.HttpResponse;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Post;
import io.micronaut.scheduling.TaskExecutors;
import io.micronaut.scheduling.annotation.ExecuteOn;

import java.util.Random;

@ExecuteOn(TaskExecutors.IO) //&lt;1&gt;
@Controller("/warehouse") // &lt;2&gt;
class WarehouseController {

    @Get("/count") // &lt;3&gt;
    HttpResponse&lt;?&gt; getItemCount() {
        return HttpResponse.ok(new Random().nextInt(11));
    }

    @Post("/order") // &lt;4&gt;
    HttpResponse&lt;?&gt; order() {
        try {
            //To simulate an external process taking time
            Thread.sleep(500);
        } catch (InterruptedException ignored) {
        }

        return HttpResponse.accepted();
    }
}
</code></pre>
<p><strong>1</strong> It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the event loop.</p>

<p><strong>2</strong> The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html"><code>@Controller</code></a> annotation mapped to the path <code>/warehouse</code>.</p>

<p><strong>3</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>getItemCount</code> method to an HTTP GET request on <code>/warehouse/count</code>.</p>

<p><strong>4</strong> The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html"><code>@Get</code></a> annotation maps the <code>order</code> method to an HTTP GET request on <code>/warehouse/order</code>.</p>
    
      <h2 id="2-setup-aws-tracing-export">
        
        
          2. Setup AWS Tracing Export <a href="#2-setup-aws-tracing-export" class="anchor_heading">#</a>
        
        
      </h2>

<p>To run tracing on AWS, run the AWS OTel Collector locally and set up the application to export traces to the collector.</p>
    
      <h3 id="21-configure-aws-authentication">
        
        
          2.1. Configure AWS Authentication <a href="#21-configure-aws-authentication" class="anchor_heading">#</a>
        
        
      </h3>

<p>To test exporting traces to AWS X-Ray from a local machine, you may use an AWS Access key configured in the AWS CLI. If you do not have AWS CLI, follow the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS documentation</a> for installing or updating the latest version of the AWS CLI.</p>

<p>If you do not have an access key, complete the steps in <a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#create-long-term-access-keys">AWS Secure Credential Types Documentation</a> to create a long-term access key for your account. Run <code>aws configure</code> and provide <strong>access key ID</strong> and <strong>secret access key</strong> to authenticate as your user.</p>

<p>Instead of using your AWS root account, use an administrator account. If you do not have one already, see <a href="/gdk/get-started/setting-up-cloud-accounts/">Setting up Your Cloud Accounts</a>.</p>
    
      <h3 id="22-run-the-aws-otel-collector">
        
        
          2.2. Run the AWS OTel Collector <a href="#22-run-the-aws-otel-collector" class="anchor_heading">#</a>
        
        
      </h3>

<p><a href="https://github.com/aws-observability/aws-otel-collector">AWS Open Telemetry Collector</a> will use the configured AWS profile to export traces to AWS X-Ray. To run the AWS Collector, you will need a configuration file.</p>

<ol>
  <li>Save the <a href="https://github.com/aws-observability/aws-otel-collector/blob/main/examples/docker/config-test.yaml">example configuration file from the AWS OTel repository</a> as <em>otel-local-config.yaml</em>:
    <pre><code class="language-bash"> curl https://raw.githubusercontent.com/aws-observability/aws-otel-collector/main/examples/docker/config-test.yaml --output otel-local-config.yaml
</code></pre>
  </li>
  <li>
    <p>Open the file and change the value of <code>exporters.awsxray.region</code> to your AWS region.</p>
  </li>
  <li>
    <p>Run the AWS Collector container image using the command similar to the following. Edit the command to match the AWS region from previous step and change the AWS profile if needed.</p>

    <pre><code class="language-bash">docker run --name awscollector --rm -p 4317:4317 -p 55680:55680 -p 8889:8888 \
    -e AWS_REGION=us-east-1 -e AWS_PROFILE=default \
    -v ~/.aws:/home/aoc/.aws -v "$(pwd)/otel-local-config.yaml:/otel-local-config.yaml" \
    public.ecr.aws/aws-observability/aws-otel-collector:latest \
    --config otel-local-config.yaml
</code></pre>
  </li>
</ol>

<blockquote>
  <p>Note: For Windows, <a href="https://learn.microsoft.com/windows/wsl/tutorials/wsl-containers#install-docker-desktop">install Docker Desktop</a>. Start the WSL terminal, and use the following command (replace <code>&lt;Username&gt;</code> with your Windows user name):</p>
  <pre><code class="language-bash">docker run --name awscollector --rm -p 4317:4317 -p 55680:55680 -p 8889:8888 \
      -e AWS_REGION=us-east-2 -e AWS_PROFILE=default \
      -v "/mnt/c/Users/&lt;Username&gt;/.aws:/home/aoc/.aws" -v "$(pwd)/otel-local-config.yaml:/otel-local-config.yaml" \
      public.ecr.aws/aws-observability/aws-otel-collector:latest \
      --config otel-local-config.yaml
</code></pre>
  <p>If you are using other container manager Desktop applications, configure WSL integration in their settings (for example, <a href="https://docs.rancherdesktop.io/getting-started/installation/#windows">Rancher Desktop</a> automatically installs WSL and configures a <a href="https://apps.microsoft.com/store/detail/windows-terminal/9N0DX20HK701?hl=en-ca&amp;gl=ca&amp;rtc=1">Windows terminal profile</a> that you can use to run the command).</p>
</blockquote>

<p>Visit the <a href="https://github.com/aws-observability/aws-otel-collector/blob/main/docs/developers/docker-demo.md">AWS OTel Docker demo documentation page</a> for more information on starting the AWS Open Telemetry Docker Collector.</p>
    
      <h3 id="23-configure-tracer">
        
        
          2.3. Configure Tracer <a href="#23-configure-tracer" class="anchor_heading">#</a>
        
        
      </h3>

<p>Change the application configuration to export traces to the AWS OTel Collector that you just started. Add the following to the <em>aws/src/main/resources/application.properties</em> configuration file:</p>

<pre><code>otel.traces.exporter=otlp
otel.traces.propagator=tracecontext, baggage, xray
</code></pre>
    
      <h2 id="3-run-the-application">
        
        
          3. Run the Application <a href="#3-run-the-application" class="anchor_heading">#</a>
        
        
      </h2>

<p>Application traces can be sent to AWS X-Ray from outside Amazon Web Services.
This allows you to run the application locally and view the traces in the AWS X-Ray Trace Explorer.</p>

<p>To run the application locally, use the following command, which starts the application on port 8080:</p>

<div id="tabs-doc3">
    <ul>
        <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
        <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
    </ul>
    <div id="gradle">
        <pre><code class="language-bash">./gradlew :aws:run</code></pre>
    </div>
    <div id="maven">
        <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw mn:run -pl aws -Dmicronaut.application.name=aws</code></pre>
    </div>
</div>
    
      <h2 id="4-test-the-application">
        
        
          4. Test the Application <a href="#4-test-the-application" class="anchor_heading">#</a>
        
        
      </h2>

<p>Test the application by accessing REST endpoints. Then review the trace output.</p>

<p>Open <a href="https://console.aws.amazon.com/xray/home#/traces">AWS X-Ray</a>:</p>

<p><img src="/gdk/docs/gdk-modules/tracing/images/aws1.png" alt="AWS X-Ray" /></p>

<p>It may take a few seconds for the traces to be displayed.</p>
    
      <h3 id="41-get-item-counts">
        
        
          4.1. Get Item Counts <a href="#41-get-item-counts" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>Send an HTTP GET request to the <code>/store/inventory/{item}</code> endpoint to get the count of an item, for example:
    <pre><code class="language-bash"> curl http://localhost:8080/store/inventory/laptop
</code></pre>
  </li>
  <li>
    <p>Open the Trace Explorer and refresh it. You should see a row in the list of traces that corresponds to the endpoint to which you sent the request:</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-4-1-2.jpg" alt="Trace Explorer Get Count" /></p>
  </li>
  <li>
    <p>Click the trace link to view its details. Each span is represented by a green bar. There is a node graph representing a request that would contain more nodes if multiple applications were used in the request or resources, such as a database.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-4-1-3.jpg" alt="Trace Details Get Count" /></p>
  </li>
</ol>
    
      <h3 id="42-order-items">
        
        
          4.2. Order Items <a href="#42-order-items" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Send an HTTP POST request to the <code>/store/order</code> endpoint to order an item, as follows:</p>

    <pre><code class="language-bash"> curl -X "POST" "http://localhost:8080/store/order" \
      -H 'Content-Type: application/json; charset=utf-8' \
      -d $'{"item":"laptop", "count":5}'
</code></pre>
  </li>
  <li>
    <p>Review the output again in the Trace Explorer: you should see a new row that represents the trace of the order. You can find it by looking at the time stamps of the traces and picking the most recent.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-4-2-2.jpg" alt="Trace Explorer Post Order" /></p>
  </li>
  <li>
    <p>Review the details.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-4-2-3.jpg" alt="Trace Details Post Order" /></p>
  </li>
</ol>
    
      <h3 id="43-get-inventory">
        
        
          4.3. Get Inventory <a href="#43-get-inventory" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Send an HTTP GET request to the <code>/store/inventory</code> endpoint to get the inventory:</p>

    <pre><code class="language-bash"> curl http://localhost:8080/store/inventory
</code></pre>
  </li>
  <li>
    <p>Review the output again in the Trace Explorer: you should see a new row that represents the trace of the request to retrieve the inventory. Click the trace link to view its details. You should see something similar to the following screenshot.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-4-3-2.jpg" alt="Trace Details Inventory All" /></p>

    <p>Looking at the trace, you may conclude that retrieving the items sequentially might not be the best design choice.</p>
  </li>
</ol>
    
      <h2 id="5-generate-a-native-executable-using-graalvm">
        
        
          5. Generate a Native Executable Using GraalVM <a href="#5-generate-a-native-executable-using-graalvm" class="anchor_heading">#</a>
        
        
      </h2>

<p>The GDK supports compiling Java applications ahead-of-time into native executables using <a href="https://www.graalvm.org/" target="_blank">GraalVM Native Image</a>.
You can use the <em><a href="https://graalvm.github.io/native-build-tools/latest/gradle-plugin.html" target="_blank">Gradle plugin for GraalVM Native Image building</a></em>/<em><a href="https://graalvm.github.io/native-build-tools/latest/maven-plugin.html" target="_blank">Maven plugin for GraalVM Native Image building</a></em>.
Packaged as a native executable, it significantly reduces application startup time and memory footprint.</p>

<blockquote>
  <p><strong>Prerequisites</strong>: Make sure you have installed a GraalVM JDK. The easiest way to get started is with <a href="https://sdkman.io/jdks#graal">SDKMAN!</a>. For other installation options, visit the <a href="https://www.graalvm.org/downloads/">Downloads section</a>.</p>
</blockquote>

<p>To generate a native executable, run the following command:</p>

<div id="tabs-doc4">
  <ul>
    <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <pre><code class="language-bash">./gradlew :aws:nativeCompile</code></pre>
  </div>
  <div id="maven">
    <pre><code class="language-bash">./mvnw install -pl lib -am
./mvnw package -pl aws -Dpackaging=native-image</code></pre>
  </div>
</div>
    
      <h2 id="6-run-and-test-the-native-executable">
        
        
          6. Run and Test the Native Executable <a href="#6-run-and-test-the-native-executable" class="anchor_heading">#</a>
        
        
      </h2>

<p>Run the native executable, using the option <code>-Dmicronaut.application.name</code> to set the name of the application as “aws-native-demo”, as follows:</p>

<div id="tabs-doc5">
  <ul>
    <li class="tabs-gradle"><a name="gradle" href="#gradle">Gradle</a></li>
    <li class="tabs-maven"><a name="maven" href="#maven">Maven</a></li>
  </ul>
  <div id="gradle">
    <pre><code class="language-bash">aws/build/native/nativeCompile/aws-tracing-demo-aws -Dmicronaut.application.name=aws-native-demo</code></pre>
  </div>
  <div id="maven">
    <pre><code class="language-bash">aws/target/aws-tracing-demo-aws -Dmicronaut.application.name=aws-native-demo</code></pre>
  </div>
</div>

<p>The native executable starts instantaneously.</p>
    
      <h3 id="61-get-item-counts">
        
        
          6.1. Get Item Counts <a href="#61-get-item-counts" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Repeat the test from step <strong>4.1</strong> by sending an HTTP GET request to the <code>/store/inventory/{item}</code> endpoint to get the count of an item:</p>

    <pre><code class="language-bash"> curl http://localhost:8080/store/inventory/laptop
</code></pre>
  </li>
  <li>
    <p>Review the trace output in Trace Explorer: you should see a new row in the list of Traces that represents the request from the native executable:</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-6-1-2.jpg" alt="Trace Explorer Get Count Natively" /></p>

    <p>Notice that the native executable requests are processed a lot faster than its original.</p>
  </li>
  <li>
    <p>Click the trace name to view its details. Each span is represented by a green bar.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-6-1-3.jpg" alt="Trace Details Get Count Natively" /></p>
  </li>
</ol>
    
      <h3 id="62-order-items">
        
        
          6.2. Order Items <a href="#62-order-items" class="anchor_heading">#</a>
        
        
      </h3>

<ol>
  <li>
    <p>Repeat the test from step <strong>4.2</strong> by sending an HTTP POST request to the <code>/store/order</code> endpoint to order an item:</p>

    <pre><code class="language-bash"> curl -X "POST" "http://localhost:8080/store/order" \
     -H 'Content-Type: application/json; charset=utf-8' \
     -d $'{"item":"laptop", "count":5}'
</code></pre>

    <p>You should see a new row in the Trace Explorer that represents the POST request.</p>
  </li>
  <li>
    <p>Click the most recent trace name to view its details.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-6-2-2.jpg" alt="Trace Details Post Order" /></p>
  </li>
  <li>
    <p>Click the span named <code>aws-native-demo: StoreController.order#store.order</code> to view its details showing the custom span attributes: <code>count</code> and <code>order.item</code>.</p>

    <p><img src="/gdk/docs/gdk-modules/tracing/images/aws-xray-6-2-3.jpg" alt="Span Details Post Order" /></p>
  </li>
</ol>
    
      <h3 id="summary">
        
        
          Summary <a href="#summary" class="anchor_heading">#</a>
        
        
      </h3>

<p>This guide demonstrated how to create and trace a Micronaut application using <a href="https://aws.amazon.com/xray/">AWS X-Ray</a>.</p>
    
      <h3 id="related-documentation">
        
        
          Related Documentation <a href="#related-documentation" class="anchor_heading">#</a>
        
        
      </h3>
<ul>
  <li><a href="https://micronaut-projects.github.io/micronaut-tracing/latest/guide/">Micronaut Tracing</a></li>
  <li><a href="https://micronaut-projects.github.io/micronaut-aws/latest/guide/">Micronaut AWS integration</a></li>
  <li><a href="https://www.graalvm.org/">GraalVM Native Image</a></li>
  <li><a href="https://graalvm.github.io/native-build-tools/latest/index.html">Native Build Tools</a></li>
</ul>

      </div>

      <div role="button" class="menu-btn menu-btn--sidebar js-show-sidebar" title="sweet hamburger">
        <div class="hamburger">
          <div class="inner"></div>
        </div>
      </div>
    </div>
  </div>
</article>



</div>

      </main>

      
<footer class="footer footer__mobile">

  <div class="container-fluid container-fluid--custom-sm">
    <div class="row">
      <div class="col-12 col-sm-12 col-md-12 col-lg-12">
        <div class="row footer-content">
          <div class="col-md-3 col-sm-4">
            <h6 class="title-footer" onclick="fadeInAndOut(this)">Learn</h6>
            <div class="grow">
              <ul class="footer-list">
                <li class="footer-list__item"><a href="/gdk/get-started/">Get Started</a></li>
                <li class="footer-list__item"><a href="/gdk/guides/">Guides</a></li>
                <li class="footer-list__item"><a href="/gdk/hands-on-labs/">Labs</a></li>
                <li class="footer-list__github">
                  <img class="footer__icon" src="/gdk/resources/img/footer/logo-github.svg" alt="Github icon">
                  <a href="https://github.com/oracle/graal-dev-kit" target="blank">Github</a>
                </li>
                <li class="footer-list__github">
                  <img class="footer__icon" src="/gdk/resources/img/footer/slack-icon.svg" alt="Github icon">
                  <a href="https://bit.ly/odevrel_slack" target="blank">#graal-dev-kit-for-micronaut</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-md-3 col-sm-4">
            <h6 class="title-footer" onclick="fadeInAndOut(this)">About</h6>
            <div class="grow">
              <ul class="footer-list">
                <li class="footer-list__item"><a href="/gdk/about/#gdk-support" target="blank">Commercial Support</a></li>
                <li class="footer-list__item"><a href="https://www.graalvm.org/" target="blank">GraalVM Native Image</a></li>
                <li class="footer-list__item"><a href="https://micronaut.io/" target="_blank">Micronaut<sup>&reg;</sup> Framework</a></li>
                <li class="footer-list__item"><a href="https://www.oracle.com/cloud/multicloud/what-is-multicloud/" target="_blank">Multicloud</a></li>
                <li class="footer-list__item"><a href="https://www.oracle.com/cloud/" target="blank">Oracle Cloud Infrastructure</a></li>
                <li class="footer-list__item"><a href="https://marketplace.visualstudio.com/items?itemName=oracle-labs-graalvm.graal-cloud-native-pack" target="blank">VS Code Tools</a></li>
              </ul>
            </div>
          </div>
          <div class="col-md-6 col-sm-12 aligning_1024">
            <div class="card--footer card--hovered box">
              <div>
                <div class="rubber-footer footer__oci-section">
                  <p class="title-footer quickstart">Build, test, and deploy applications on Oracle Cloud Infrastructure for free</p>
                  <a href="https://www.oracle.com/cloud/free/" target="_blank"
                    class="btn btn-primary">Try Oracle Cloud Infrastructure Free Tier</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
          <div class="row">
            <div class="col-sm-12">
              <p class="copyright">
                Copyright &copy; 2023-2024, Oracle and/or its affiliates.
                All rights reserved.
                Oracle and Java are registered trademarks of Oracle and/or its affiliates.<br/>
                Micronaut<sup>&reg;</sup> is a registered trademark of Object Computing, Inc.
                Use is for referential purposes and does not imply any endorsement or affiliation with any third-party product.
                Unauthorized use is strictly prohibited. Other names may be trademarks of their respective owners.
              </p>
              <div id="teconsent"></div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</footer>

<script>
  function fadeInAndOut(thz) {
    var elmt = thz.nextElementSibling;//Get the element that is below the button that
    //was just clicked
    if (elmt.clientHeight) {
      elmt.style.height = 0;
    } else {
      var wrapper = elmt.querySelector('ul');
      elmt.style.height = wrapper.clientHeight + "px";
    }
    /*
        elmt.classList.toggle("acordianPanelHidden");//Toggle the class which changes
        //attributes which triggers the transition CSS
        */
  }

  // Check TRUSTe Consent for Functional or Implied Approval
  // The if test verifies if the user has given the consent
  if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
      (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
        oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(2) != -1) ) {

      //The following is a sample of a Maxymiser Tag being written to the DOM
      //If the user did not give consent, then the tag is not included and not invoked in the Browser
      document.write('<script type="text/javascript" src="//service.maxymiser.net/cdn/oracle/js/mmcore.js"><\/script>');
  }

  // Check TRUSTe Consent for Advertising or Implied Approval
  // The if test verifies if the user has given the consent
  if ( (oracle.truste.api.getGdprConsentDecision().consentDecision) &&
      (oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(0) != -1 ||
        oracle.truste.api.getGdprConsentDecision().consentDecision.indexOf(3) != -1) ) {

      //The following is a sample of a BlueKai Core Tag being written to the DOM
      //If the user did not give consent, then the tag is not included and not invoked in the Browser
      document.write('<script type="text/javascript">' +
      'window.bk_async = function() { ' +
      'BKTAG.doTag(62581, 1); }; ' +
      '(function() { ' +
      'var scripts = document.getElementsByTagName(\'script\')[0]; ' +
      'var s = document.createElement(\'script\'); ' +
      's.async = true; ' +
      's.src = "https://tags.bkrtx.com/js/bk-coretag.js"; ' +
      'scripts.parentNode.insertBefore(s, scripts); ' +
      '}()); ' +
      '<\/script>');
  }
</script>

    </div>
    <div class="overlay"></div>

    <!-- Start SiteCatalyst code -->
    <script language="JavaScript" src="https://www.oracle.com/us/assets/metrics/ora_otn.js"></script>
    <!-- End SiteCatalyst code -->

    <script src='/gdk/resources/lib/slick-slider/slick.min.js'></script>
    <script src='/gdk/resources/js/main.js'></script>
    <script src='/gdk/resources/js/ui.js'></script>
    <script src='/gdk/resources/js/filters.js'></script>
    <script src='/gdk/resources/js/sidebar.js'></script>
    <script src='/gdk/resources/js/labs.js'></script>
    <script src='/gdk/resources/lib/highlight/highlight.min.js'></script>
    <script>hljs.highlightAll();</script>
  </body>
</html>
